!function(){var e={};e.alerts=!1,e.logRun=!1,e.log=function(){e.logRun&&Function.prototype.apply.call(console.log,console,arguments)},e.imgbase="../img/",e.log(e),e.init=function(){e.tooltip.init(),e.titles=$.t("vesper.visTitles",{returnObjectTrees:!0})},"function"==typeof define&&define.amd?define(e):"object"==typeof module&&module.exports?module.exports=e:this.VESPER=e}(),VESPER.BarChart=function(e){function t(){i=l.chunkInfo(v,l.getModelData(v),S),1===l.childScale.domain()[1]&&l.childScale.domain(i.extremes),VESPER.log("bin data",i.extremes,i)}var n,a,r=d3.svg.axis();this.format=void 0,this.rsminformat=d3.format(","),this.rsmaxformat=this.rsminformat,this.barClass="countBin",this.childScale=d3.scale.linear();var i,o,l,s=d3.scale.log().base(10),c=s,d="interval",u="⁰¹²³⁴⁵⁶⁷⁸⁹",p=function(e){return(e+"").split("").map(function(e){return"-"==e?e:u[e]}).join("")},h=[void 0,void 0],f=MGNapier.NapVisLib.rangeSlider();f.tooltipTemplates({min:function(e,t){return l.rsminformat(l.wrapDataType(l.makeToNearest(t.invert(e[0]))))},max:function(e,t){return l.rsmaxformat(l.wrapDataType(l.makeToNearest(t.invert(e[1]))))},bar:function(){return null}});var v,g,m=500,E=500,S={},y={left:55,right:45,top:15,bottom:40};this.minBarWidth=5,this.toNearest=1,this.divisions=[1,2,10,100];var x=function(e){var t=a[1]-y.bottom;e.attr("x",function(e){return l.childScale(e.start)}).attr("width",function(e){return l.childScale(e.end)-l.childScale(e.start)}).attr("y",function(e){return e.count?c(e.count):t}).attr("height",function(e){return e.count?t-c(e.count):0}).style("opacity",1)};this.set=function(t,n){S.keyField=n.makeIndices([t.identifyingField])[0],S.dateField=n.makeIndices([t.dateField])[0],S.realField=n.makeIndices([t.realField])[0],a=[$(e).width(),$(e).height()],v=n},this.resized=function(){a=[$(e).width(),$(e).height()],this.childScale.range([y.left,a[0]-y.right]),f.scale(this.childScale).setRange(g?g.map(function(e){return this.childScale(e)},this):this.childScale.range()).update(),this.update()},this.go=function(){l=this,d3.select(e).style("overflow","hidden");var r=d3.select(e).selectAll("svg").data([0]);r.enter().append("svg:svg").attr("class","visContainer").attr("pointer-events","all"),r=d3.select(e).select("svg"),n=r.append("svg:g").attr("class","treeSVG");var o=d3.select(e).select(".visControl"),s=e.substring(1);if(o.empty()){var c=d3.select(e).append("div").attr("class","visControl").attr("id",s+"Controls");VESPER.DWCAHelper.addDragArea(c);var u=c.append("div").attr("id",s+"accordion"),p=[$.t("barChart.typeLabel")];u.selectAll("h3").data(p).enter().append("h3").text(function(e){return e}),u.selectAll("div.accordSection").data(["Totals"]).enter().insert("div",function(e,t){return u.select("h3:nth-of-type("+(t+2)+")").node()}).attr("class","accordSection").attr("id",function(e){return s+"Controls"+e});var h=["interval","cumulative"],v={};h.forEach(function(e){v[e]=$.t("barChart."+e+"Label")});var g=u.select(e+"ControlsTotals").selectAll("span.fieldGroup").data(h,function(e){return e});g.enter().append("span").attr("class","fieldGroup"),g.append("input").attr("type","radio").attr("id",function(e){return s+e}).attr("name",s+"chartYType").property("checked",function(e){return e===d}).on("change",function(e){d=e,t(),l.update()}),g.append("label").attr("for",function(e){return s+e}).text(function(e){return v[e]}),$(e+"accordion").accordion({heightStyle:"content",collapsible:!0,active:!1}),$(e+"Controls").draggable({containment:e})}l.childScale.range([y.left,a[0]-y.right]),t();var m=r.select("g.rangeHolder");m.empty()&&r.append("g").attr("class","rangeHolder").attr("transform","translate(0,"+(a[1]-20)+")"),m=r.select("g.rangeHolder"),f(m),f.scale(l.childScale).dragEndFunc(function(e,t){var n=e.map(function(e){return t.invert(e)});l.setRangeSliderDomain(n[0],n[1])}).update(),m.select("rect.sliderBar").on("contextmenu",function(){P(i.bins[0].start,i.bins[i.bins.length-1].end),d3.event.preventDefault()}).on("mouseout",function(){VESPER.tooltip.setToFade()}).on("mouseover",function(){VESPER.tooltip.updateText($.t("barChart.rangeSliderBarHeader"),$.t("barChart.rangeSliderBarText")),VESPER.tooltip.updatePosition(d3.event)}),l.update()},this.getModelData=function(e){return e.getData()},this.makeToNearest=function(e){return Math.round(e/l.toNearest)*l.toNearest},this.setRangeSliderDomain=function(e,n){h=[l.wrapDataType(l.makeToNearest(e)),l.wrapDataType(l.makeToNearest(n))],g=h;var a=h.map(function(e){return f.scale()(e)});f.setRange(a).update(),t(),l.update()};var P=function(e,t){v.getSelectionModel().clear();var n=l.returnMatches(v,S,e,t);v.getSelectionModel().addAllToMap(n)};this.update=function(){o=l.chunkInfo(v,l.getModelData(v),S,function(e){return v.getSelectionModel().contains(e)});var e=i.bins;VESPER.log("Selection bins",o);var t=d3.max(e,function(e){return e.count+1});VESPER.log("Max height",t);var r=a[1]-y.bottom;c.domain([.1,t]).range([r,y.top]).nice();var s=n.select("g.valueAxis");s.empty()&&(s=n.append("g").attr("class","valueAxis vesperAxis").attr("transform","translate (0,"+(a[1]-y.bottom)+")")),s.call(d3.svg.axis().scale(l.childScale).orient("bottom").tickFormat(l.format));for(var d=[e,o.bins],u=["unselected","selected"],p=0;p<d.length;p++){VESPER.log("bins",d[p]);var h=l.barClass,f=n.selectAll("."+h+"."+u[p]).data(d[p],function(e){return Math.floor(e.start)});f.exit().on("mouseout",null).on("mouseover",null).on("contextmenu",null).on("click",null).remove(),l.redraw(f,d[p]);var g=f.empty()?0:m;f.enter().append("svg:rect").attr("class",h+" "+u[p]).style("opacity",0).on("contextmenu",function(e){P(e.start,e.end),d3.event.preventDefault()}).on("mouseover",function(e){d3.select(this).classed("highlight",!0);var t=d3.select(this).classed("selected");VESPER.tooltip.updateText($.t("barChart."+(t?"selLabel":"allLabel")),l.makeTitle(e)).updatePosition(d3.event)}).on("mouseout",function(){d3.select(this).classed("highlight",!1),VESPER.tooltip.setToFade()}).on("click",function(e){l.setRangeSliderDomain(e.start,e.end)}).transition().delay(g).duration(E).call(x)}},this.redraw=function(e){var t=a[1]-y.bottom;c.range([t,y.top]).nice();var i=n.select("g.countAxis");i.empty()&&(i=n.append("g").attr("class","countAxis vesperAxis").attr("transform","translate ("+(y.left-1)+",0)")),i.call(r.scale(c).orient("left").ticks(6,d3.format(",d")).tickFormat(function(e){var t=Math.log(e)/Math.LN10,n=Math.round(t);return Math.abs(t-n)<.001?n>3?"10"+p(n):Math.round(e):void 0})),e.transition().duration(m).call(x)},this.makeTitle=function(){},this.updateVals=this.update,this.chunkInfo=function(e,t,n,a){function r(){if(!f||!v)for(var a in t)if(t.hasOwnProperty(a)){var r=c.getVal(e,t,a,n);if(void 0!==r){r=c.wrapDataType(r,a);var i=c.unwrapDataType(r);m++,!f&&(void 0===u||o>i)&&(u=r,o=c.unwrapDataType(u)),!v&&(void 0===p||i>s)&&(p=r,s=c.unwrapDataType(p))}}}function i(){var r=0;for(var i in t)if(t.hasOwnProperty(i)&&(!a||a(i,t))){var o=c.getVal(e,t,i,n);if(void 0!==o&&(o=c.unwrapDataType(c.wrapDataType(o,i)),!isNaN(o)))if(o>=E){var l=Math.floor((o-D)/P);l>=0&&R>=l&&g[l].count++}else r++}return r}var o,s,c=l,u=h[0],p=h[1],f=void 0!==u,v=void 0!==p,g=[],m=0;if(r(),void 0!==u&&void 0!==p){var E=c.unwrapDataType(u),S=c.unwrapDataType(p),y=Math.ceil(S/l.toNearest)*l.toNearest-Math.floor(E/l.toNearest)*l.toNearest;VESPER.log("Mins and Maxs",S,E,u,p,y,l.childScale.range());var x=c.makeBarSizes(l.childScale.range()[1]-l.childScale.range()[0],y),P=x.newBinSize,R=x.newBinCount;VESPER.log("Bin size & count",P,R);for(var D=Math.floor(E/P)*P,T=0;R+1>T;T++){var b=D+P*T;g[T]={count:0,start:c.wrapDataType(Math.max(b,E)),end:c.wrapDataType(Math.min(b+P,S+P))}}var V=i();"cumulative"===d&&c.calcCumulative(g,V)}return{extremes:[u,p],bins:g}},this.returnMatches=function(e,t,n,a){var r=[],i=l.getModelData(e);for(var o in i)if(i.hasOwnProperty(o)){var s=l.getVal(e,i,o,t);void 0!==s&&(s=l.wrapDataType(s,o),s>=n&&a>s&&r.push(o))}return VESPER.log("Min, max, array of matches",n,a,r),r},this.calcCumulative=function(e,t){VESPER.log("Bins",e);for(var n=t,a=0;a<e.length;a++){var r=e[a].count;e[a].count+=n,n+=r}},this.makeBarSizes=function(e,t){for(var n,a=t/e*l.minBarWidth,r=0;r<l.divisions.length;r++)if(l.divisions[r]>a||r===l.divisions.length-1){n=l.divisions[r];break}VESPER.log("Bar domain width, phys range, phys width",a,t,e);var i=Math.ceil(t/n);return{newBinSize:n,newBinCount:i}},this.getRangeSlider=function(){return f},this.baseDestroy=function(){VESPER.DWCAHelper.recurseClearEvents(d3.select(e));var t=n.selectAll("."+l.barClass);t.remove(),$(e+"accordion").accordion("destroy"),$(e+"Controls").draggable("destroy"),v.removeView(l),v=null,VESPER.DWCAHelper.twiceUpRemove(e)},this.destroy=function(){this.baseDestroy()}},VESPER.TaxaDistribution=function(e){var t=new VESPER.BarChart(e);return t.makeTitle=function(e){return $.t("barChart.taxaTooltip",{count:e.end-e.start,start:e.start,end:e.end-1})+"<br>"+$.t("barChart.taxaCountLabel",{count:e.count})},t.wrapDataType=function(e){return e},t.unwrapDataType=function(e){return e},t.getVal=function(e,t,n,a){var r=e.getIndexedDataPoint(t[n],a.keyField),i=e.getIndexedDataPoint(t[n],a.realField);if(i===r||void 0==i){var o=e.getNodeFromID(n),l=e.getSubTaxa(o);return l?l.length:0}return void 0},t.divisions=[1,2,10,100,1e3],t},VESPER.ExpTaxaDistribution=function(e){var t=new VESPER.TaxaDistribution(e);return t.getModelData=function(e){return e.getExplicitTaxonomy()},t},VESPER.TimeLine=function(e){var t=new VESPER.BarChart(e),n={};t.childScale=d3.time.scale(),t.barClass="timeBin",t.format=null,t.rsminformat=d3.time.format("%a, %d %B %Y"),t.rsmaxformat=d3.time.format("%Y %B %d, %a"),t.ttformat=d3.time.format("%a, %d %B %Y, %H:%M"),t.makeTitle=function(e){return t.ttformat(e.start)+"<br>to "+t.ttformat(e.end)+"<br>Records: "+e.count},t.wrapDataType=function(e,t){var a=void 0===t?void 0:n[t];return void 0===a?new Date(e):a},t.unwrapDataType=function(e){return e.getTime()},t.getVal=function(e,t,a,r){var i=e.getIndexedDataPoint(t[a],r.dateField);return n[a]||void 0===i||(n[a]=new Date(i),i.length<6&&n[a].setHours(23,59)),i},t.destroy=function(){t.baseDestroy(),n={}};var a=864e5;return t.toNearest=7*a,t.divisions=[a,7*a,91.3125*a,365.25*a,365.25*a*10],t},VESPER.DWCAModel=function(e,t){this.getMetaData=function(){return this.metaData},this.getData=function(){return this.data.records},this.getImplicitTaxonomy=function(){return this.data.impTree.tree},this.getImplicitRoot=function(){return this.data.impTree.root},this.getExplicitTaxonomy=function(){return this.data.expTree.tree},this.getExplicitRoot=function(){return this.data.expTree.root};var n=0,a=0,r=new MGNapier.SharedSelection,i=VESPER.DWCAParser,o=i.DCOUNT,l=i.TDATA;this.getSelectionModel=function(){return r},this.invertSelection=function(){var e=this.getData(),t=this.getSelectionModel(),n=[];for(var a in e)t.contains(a)||n.push(a);t.clear(),t.addAllToMap(n)},this.getParser=function(){return i},this.getExtraData=function(e){return e[i.EXT]},this.getTaxaData=function(e){return e[l]},this.getSynonyms=function(e){return e[i.SYN]},this.getRowData=function(e,t){return void 0==t?this.getTaxaData(e):void 0==this.getExtraData(e)?void 0:this.getExtraData(e)[t]},this.getSubTaxa=function(e){return e[i.TAXA]},this.getSpecimens=function(e){return e[i.SPECS]},this.getDescendantCount=function(e){return e[o]},this.getSynonymCount=function(e){return e[i.SYNCOUNT]||(this.getSynonyms(e)?this.getSynonyms(e).length:0)},this.getSpecimenCount=function(e){return e[i.SPECCOUNT]||(this.getSpecimens(e)?this.getSpecimens(e).length:0)},this.getObjectCount=function(e){return(e[o]||0)+this.getSynonymCount(e)+this.getSpecimenCount(e)},this.getSelectedDescendantCount=function(e){return e[i.SEL_DCOUNT]},this.getSelectedSynonymCount=function(e){return e[i.SEL_SYNCOUNT]},this.getSelectedSpecimenCount=function(e){return e[i.SEL_SPECCOUNT]},this.getSelectedObjectCount=function(e){return(e[i.SEL_DCOUNT]||0)+(e[i.SEL_SYNCOUNT]||0)+(e[i.SEL_SPECCOUNT]||0)},this.getLeafValue=function(e){var t=this.getSpecimens(e);return t?t.length:1},this.getNodeFromID=function(e){return this.getData()[e]||(this.getExplicitTaxonomy()?this.getExplicitTaxonomy()[e]:void 0)},this.getLabel=function(e){var t=this.getMetaData().vesperAdds.nameLabelField;return this.getDataPoint(e,t)},this.getDataPoint=function(e,t){var n=this.getMetaData().fileData[t.rowType];void 0==n&&VESPER.log("UNDEFINED ROW",t,this.getMetaData());var a=n.filteredFieldIndex,r=a[t.fieldType];if(void 0==r)return void 0;var i=n.extIndex;return void 0==i?this.getTaxaData(e)[r]:this.getExtraData(e)?this.getExtraData(e)[i][0][r]:void 0},this.getIndexedDataPoint=function(e,t){return void 0==t||void 0==t.fieldType?void 0:void 0==t.rowIndex?this.getTaxaData(e)[t.fieldIndex]:this.getExtraData(e)?this.getExtraData(e)[t.rowIndex][0][t.fieldIndex]:void 0},this.getIndexedDataPoints=function(e,t,n){if(void 0!==t&&void 0!==t.fieldType)if(void 0==t.rowIndex)n.push(this.getTaxaData(e)[t.fieldIndex]);else if(this.getExtraData(e))for(var a=this.getExtraData(e)[t.rowIndex],r=0;r<a.length;r++)n.push(a[r])},this.makeIndices=function(e){for(var t=[],n=0,a=e.length;a>n;n++)t.push(this.makeIndex(e[n]));return t},this.makeIndex=function(e){var t=this.getMetaData().fileData;for(var n in t)if(t.hasOwnProperty(n)){var a=t[n].filteredFieldIndex[e];if(void 0!==a)return{rowIndex:t[n].extIndex,rowType:n,fieldIndex:a,fieldType:e}}return null},this.getRowRecords=function(e,t){return void 0==t?this.getTaxaData(e):this.getExtraData(e)?this.getExtraData(e)[t]:void 0},this.addView=function(e){r.addSingleVis(e),n++,a++},this.removeView=function(e){r.removeVis(e),n--},this.getViewCount=function(){return n},this.getNextSessionModelViewID=function(){return a},this.update=function(){r.update()},this.countSelectedDesc=function(e,t){this.countSelectedDescNew(e,t)},this.countSelectedDescNew=function(e,t){this.doSelectCount(e,t,i.SEL_DCOUNT,this.getSubTaxa,this.getDescendantCount),this.doSelectCount(e,t,i.SEL_SYNCOUNT,this.getSynonyms,this.getSynonymCount),this.doSelectCount(e,t,i.SEL_SPECCOUNT,this.getSpecimens,this.getSpecimenCount)},this.doSelectCount=function(e,t,n,a,r){var i=this.getSubTaxa(e),o=a?a(e):void 0,l=r?r.call(this,e):0,s=o?o.length:0,c=0;if(l||s){if(s)for(var d=s;--d>=0;)c+=this.getSelectionModel().contains(this.getIndexedDataPoint(o[d],t))?1:0;if(l>s)for(var d=i.length;--d>=0;)c+=this.doSelectCount(i[d],t,n,a,r);e[n]=c}return c||0},this.selectSubTree=function(e,t){this.getSelectionModel().clear();var n=[];this.selectSubTreeR(e,n,t,!0),this.getSelectionModel().addAllToMap(n)},this.selectSubTreeR=function(e,t,n,a){var r=this.getIndexedDataPoint(e,n);t.push(r);var i=this.getSubTaxa(e);if(i)for(var o=i.length;--o>=0;)this.selectSubTreeR(i[o],t,n,a);var l=this.getSpecimens(e);if(l)for(var o=l.length;--o>=0;)this.selectSubTreeR(l[o],t,n,a);var s=this.getSynonyms(e);if(s)for(var o=s.length;--o>=0;)this.selectSubTreeR(s[o],t,n,!1)},t.impTree=t.impTree||{},t.expTree=t.expTree||{},this.data=t,this.metaData=e},VESPER.demo=function(e,t){function n(){return p}function a(e){d3.select("#showOnZipLoadDiv").style("display","none"),d3.select("#selDiv").style("display","block"),d3.select("#filenamePlaceholder").html(e.name),d3.select("#filesizePlaceholder").html("..."),d3.select("#dynamicSelectDiv").selectAll("span input").property("checked",!1),d3.select("#loadButton").property("disabled",!0)}function r(n){for(var r=["description","origin","DOI"],i=r.map(function(e){return $.t("demo."+e+"s",{returnObjectTrees:!0})}),o=n.length;--o>=0;)for(var l=0;l<i.length;l++)n[o][r[l]]=i[l][e[o].name];var s=d3.select(t).select("table");if(s.empty()){s=d3.select(t).append("table");var c=s.append("tr"),d=[$.t("demo.dataHeader")];r.forEach(function(e){d.push($.t("demo."+e+"sHeader"))});var u=c.selectAll("th").data(d);u.enter().append("th").text(function(e){return e})}var p=s.selectAll("tr").data(n,function(e){return void 0==e?void 0:e.name}),h=p.enter().append("tr");h.append("td").append("button").attr("class","choice").attr("type","button").attr("id",function(e){return e.name}).text(function(e){return e.name}).on("click",function(e){MGNapier.NapVisLib.xhr2(e.file,"text/plain; charset=x-user-defined",function(e){var t=MGNapier.NapVisLib.getText(e);MGNapier.NapVisLib.showProps(e),S(t)}),a(e)}),r.forEach(function(e){h.append("td").html(function(t){var n=t[e];return t[e]&&"http://"===t[e].slice(0,7)&&(n='<a href="'+n+'">'+n+"</a>"),n})}),f.makeProgressBar(void 0,E,"loadProgressDiv"),MGNapier.NapVisLib.makeFileLoadButton(d3.select("#yourData"),"choice","localLoader","Load",function(e,t){a(e),S(t)}),d3.select("#localLoader").on("mouseout",function(){VESPER.tooltip.setToFade()}).on("mouseover",function(){VESPER.tooltip.updateText($.t("web.YourTab"),$.t("demo.loadButtonTooltip")).updatePosition(d3.event)})}function i(e,t){var a=d3.select("#listDiv"),r=d3.select("#dynamicSelectDiv");e.forEach(function(e){e.title=VESPER.titles[e.type]});var i=function(e){var t=d3.select(this).property("checked");f.setAllFields(a,t,e.attList,f.isIdWrap,n(),h);var i=d3.select(this.parentNode).attr("class"),o=r.selectAll("span."+i+" input[type='checkbox']"),l=f.reselectActiveVisChoices(o,a,function(){return n()},h);d3.select("#loadButton").property("disabled",l.empty())},o=f.addCheckboxes(r,e,"fieldGroup");o.on("mouseout",function(){VESPER.tooltip.setToFade()}).on("mouseover",function(e){VESPER.tooltip.updateText(e.title,$.t("vesper.visHelpTips."+e.type)).updatePosition(d3.event)}).selectAll("input").on("click",i);var l=d3.select("#labelSelectDiv"),u=[];t.forEach(function(e){u.push({fieldType:e,rowType:void 0})});var p=function(e){return e.fieldType},v=f.addRadioButtons(l,u,"fieldGroup","nameChoice",p,p);f.configureRadioButtons(v,a,function(e){n().vesperAdds.nameLabelField=$.extend({},e),d()},function(){return n()},h),v.on("mouseout",function(){VESPER.tooltip.setToFade()}).on("mouseover",function(e){console.log(e);var t=VESPER.DWCAParser.descriptors[e.fieldType];t&&VESPER.tooltip.updateText(e.fieldType,t).updatePosition(d3.event)});var g=function(e){var t=d3.select("#dynamicSelectDiv").selectAll(".fieldGroup input");if(t=t.filter(function(){return"none"!==d3.select(this).style("display")}),t.property("checked",e),!e){var a=d3.select("#labelSelectDiv").selectAll(".fieldGroup input");a=a.filter(function(){return"none"!==d3.select(this).style("display")}),a.property("checked",e),n().vesperAdds.nameLabelField=null}};f.addHelperButton(d3.select("#advancedSelectDiv"),a,"Remove Verbose Fields",VESPER.DWCAParser.flabbyLists.wordyList,!1,null,"selButtonStyle listCon",function(){return n()},h);var m=function(e,t){return 0===t};d3.select("#allButton").on("click",function(){return f.setAllFields(a,!0,void 0,m,n(),h),g(!0),!1}),d3.select("#clearButton").on("click",function(){return f.setAllFields(a,!1,void 0,m,n(),h),g(!1),!1});var E=f.addCheckboxes(d3.select("#advancedSelectDiv"),[{title:"Search DWCA Extensions",image:null}],"fieldGroup");E.select("input").property("checked",h.useExtRows).on("click",function(){h.useExtRows=!h.useExtRows,s(n()),c(n())});var S=f.addCheckboxes(d3.select("#advancedSelectDiv"),[{title:"Select First Matching Field Only",image:null}],"fieldGroup");S.select("input").property("checked",h.selectFirstOnly).on("click",function(){h.selectFirstOnly=!h.selectFirstOnly});var y=function(){var e=d3.select(this).property("checked")?"block":"none";return d3.selectAll("#advancedSelectDiv","#listDiv").style("display",e),!1},x=f.addCheckboxes(d3.select("#advRevealPlaceholder"),[{title:"Advanced Options",image:null}],"showAdv");x.select("input").on("click",y)}function o(e,t){function n(e,t){d3.select("#"+E).select("p").html($.t("demo.zipProcTemplate",{fileName:e,count:t}))}var a=$('#tabs a[href="#small"]').parent().index();$("#tabs").tabs("option","active",a),d3.select("#"+E).style("display","block"),VESPER.DWCAZipParse.setNotifyFunc(n);var r=function(e){u=e,l()};VESPER.DWCAParser.filterReadZipEntriesToMakeModel(e,t,r)}function l(){VESPER.log("META",p),VESPER.log("MODEL",u),VESPER.alerts&&alert("mem monitor point X"),d3.select("#selDiv").style("display","none"),d3.select("#allVisDiv").style("display","block"),d3.select("#"+E).select("p").html($.t("demo.initViewsMessage")),setTimeout(function(){u.name=d3.select("#filenamePlaceholder").text().replace(/\W/g,""),(new VESPER.VisLauncher).makeVis(g[0],u),d3.select("#"+E).style("display","none"),u=null,p=null},1)}function s(e){var t=d3.select("#labelSelectDiv").selectAll("span.fieldGroup");t.style("display",function(t){var n=f.fieldListExistence(e,[t.fieldType],!0,void 0,h.useExtRows);return n.fields.length>0&&(t.rowType=n.fields[0].rowName),n.match?null:"none"})}function c(e){var t=d3.select("#dynamicSelectDiv").selectAll("span.fieldGroup");t.property("checked",!1).style("display",function(t){var n=f.fieldListExistence(e,t.attList,t.matchAll,t.matchAtLeast,h.useExtRows);return n.match?null:"none"})}function d(){var e=d3.select("#dynamicSelectDiv").selectAll("span.fieldGroup input");f.reselectActiveVisChoices(e,d3.select("#listDiv"),function(){return n()})}VESPER.init();var u,p,h={useExtRows:!0,selectFirstOnly:!0},f=VESPER.DWCAHelper,v=VESPER.DWCAParser.neccLists,g=[{type:"VisLauncher",multiple:!1,attList:["unachievable"],matchAll:!0,image:VESPER.imgbase+"tree.png",height:"null",width:"200px",newVisFunc:function(e){return new VESPER.VisLauncher(e,{autoLaunch:"on"})},setupFunc:function(){return{visChoiceData:g}}},{type:"ImplicitTaxonomy",multiple:!0,attList:v.impTaxonomy,matchAll:!0,image:VESPER.imgbase+"tree.png",height:"600px",newVisFunc:function(e){return new VESPER.ImplicitTaxonomy(e)},setupFunc:function(){return{rankField:"taxonRank"}}},{type:"ExplicitTaxonomy",multiple:!0,attList:v.expTaxonomy,matchAtLeast:2,matchAll:!1,image:VESPER.imgbase+"tree.png",height:"600px",newVisFunc:function(e){return new VESPER.ExplicitTaxonomy(e)},setupFunc:function(){return{rankField:"taxonRank"}}},{type:"DWCAMapLeaflet",multiple:!0,attList:v.geo,matchAll:!0,image:VESPER.imgbase+"world.png",height:"400px",newVisFunc:function(e){return new VESPER.DWCAMapLeaflet(e)},setupFunc:function(){return{latitude:"decimalLatitude",longitude:"decimalLongitude"}}},{type:"TimeLine",multiple:!0,attList:v.basicTimes,matchAll:!0,image:VESPER.imgbase+"calendar.png",height:"200px",newVisFunc:function(e){return VESPER.TimeLine(e)},setupFunc:function(){return{dateField:"eventDate"}}},{type:"Sanity",multiple:!0,attList:[],matchAll:!1,image:VESPER.imgbase+"comment.png",height:"400px",newVisFunc:function(e){return new VESPER.Sanity(e)},setupFunc:function(){return void 0}},{type:"RecordDetails",multiple:!0,attList:[],matchAll:!1,image:VESPER.imgbase+"comment.png",height:"auto",width:"auto",newVisFunc:function(e){return new VESPER.RecordDetails(e)},setupFunc:function(){return void 0}},{type:"ImpTaxaDistribution",multiple:!0,attList:v.impTaxonomy,matchAll:!0,image:VESPER.imgbase+"dist.png",height:"200px",newVisFunc:function(e){return VESPER.TaxaDistribution(e)},setupFunc:function(){return{realField:"acceptedNameUsageID",rankField:"taxonRank"}}},{type:"ExpTaxaDistribution",multiple:!0,attList:v.expTaxonomy,matchAtLeast:2,matchAll:!1,image:VESPER.imgbase+"dist.png",height:"200px",newVisFunc:function(e){return VESPER.ExpTaxaDistribution(e)},setupFunc:function(){return{realField:"id",rankField:"taxonRank"}}},{type:"FilterView",multiple:!0,attList:[],matchAll:!1,image:VESPER.imgbase+"search.png",height:"null",width:"auto",newVisFunc:function(e){return new VESPER.FilterView(e)},setupFunc:function(){return{}}}],m=g.slice(0,6),E="vesperProgressBar",S=function(e){var t=d3.select("#filesizePlaceholder");t.html(null),t.append("img").attr("class","vesperIcon").attr("src",VESPER.imgbase+"zipIcon.gif"),t.append("span").text((e.length||e.byteLength).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+" bytes"),VESPER.alerts&&alert("check memory use in task manager");var n=VESPER.DWCAParser.accessZip(e,"meta.xml"),a=n.meta;if(p=a,p.error)alert(p.error+" "+$.t("demo.DWCAErrorMeta"));else{var r=n.jszip;f.makeFieldSelectionBoxes(a,d3.select("#listDiv")),d3.select("#loadButton").on("click",null).on("click",function(){return o(r,a),!1}),c(a),s(a);var i=d3.select("#labelSelectDiv").selectAll("span.fieldGroup"),l=!0;i.each(function(){if(l&&"none"!==d3.select(this).style("display")){l=!1;var e=d3.select(this).select("input");$(e.node()).click()}}),d3.select("#showOnZipLoadDiv").style("display","block")}},y=function(){r(e),i(m,VESPER.DWCAParser.labelChoiceData)};VESPER.DWCAParser.init(function(){VESPER.log("CALLBACK CALLED"),y()})},VESPER.DWCAHelper=new function(){function e(e){var t=this.checked,n=d3.select(this.parentNode),a=VESPER.DWCAParser.controlledVocabSet[e]?"#999977":"#888888";n.style("background",t?"":a)}function t(e,t){return e.invFieldIndex[e.idIndex]===t}function n(e,n){return 1==e.selectedItems[n]||t(e,n)}function a(e,t,n){e.selectedItems[t]=n}function r(e){return e.selected===!0}function i(e,t){e.selected=t}function o(a,i,o){VESPER.log("Table, metadata, table key",a,i,o);var l=i.fileData[o],s=r(l);a.style("background",s?"":"#888888"),a.selectAll("td").style("background",function(t){return n(l,t)&&s?e(t):"#888888"}),a.selectAll("td input").attr("disabled",function(e){return t(l,e)||!s?"disabled":null}).property("checked",function(e){return n(l,e)}),a.selectAll("th").style("background",function(t){return s?e(t):"#888888"}),a.selectAll("th input").property("checked",function(){return s})}var l=this;return this.getSelectedTickBoxValues=function(e,t){function n(){this.checked&&(i[this.value]=!0)}var a="input[type=checkbox]"+(t?"."+t:""),r=d3.select(e).selectAll(a),i={};return r.each(n),i},this.isIdWrap=function(e,n){return t(e,n)},this.makeFieldSelectionBoxes=function(l,s){function c(r,i){VESPER.log("makerow args",arguments);var s=r;VESPER.log("table index and datum",i,r);var c=d3.select(this),d=c.attr("id"),u=r.value.invFieldIndex.filter(function(e){return void 0!==e}),p=c.selectAll("tr.col").data(u);p.exit().selectAll("input").on("click",null),p.exit().remove();var h=p.enter().append("tr").attr("class","col").append("td");h.append("input").attr("type","checkbox").attr("class","CSVField"),h.append("label");var f=p.select("td");f.select("input").property("checked",function(e){return n(s.value,e)}).attr("id",function(e){return d+e}).attr("value",function(e,t){return t}).attr("name",function(e){return e}).attr("disabled",function(e){return t(s.value,e)?"disabled":null}).on("click",null).on("click",function(e){var t=this.checked;return VESPER.log("File data object entry",s,t,this),a(s.value,e,t),o(c,l,s.key),!0}).each(e),f.select("label").attr("for",function(e){return d+e}).text(function(e){return e})}i(VESPER.DWCAParser.getFileDatum(l,!0),!0),VESPER.log("meta",l);for(var d=d3.entries(l.fileData),u=0;u<d.length;u++)d[u].value.selectedItems=d[u].value.selectedItems||{};var p=s.selectAll("div.selectBox").data(d,function(e){return e.key});p.exit().selectAll("input").on("click",null),p.exit().remove();var h=Math.floor(100/d.length)-2,f=p.enter().append("div").attr("class","selectBox").append("table"),v=function(e){var t=e.value||e;return t.mappedRowType+"_"+t.fileName};p.style("width",h+"%").select("table").attr("class",function(e){return"core"===e.key?"coreTable":null}).attr("id",v);var g=f.append("tr").append("th");g.append("input").attr("type","checkbox").attr("class","extensionFile").attr("id",function(e){return"cbox"+v(e)}).property("checked",function(e){return r(e.value)}).attr("value",v).attr("name",v).attr("disabled",function(e){return"core"===e.key?"disabled":null}).on("click",function(e,t){var n=this.checked;return VESPER.log("check",n,this),i(e.value,n),o(d3.select(f[0][t]),l,e.key),!0}).each(e),g.append("label").attr("for",function(e){return"cbox"+v(e)}).text(function(e){return e.value.mappedRowType}),p.selectAll("table").each(c)},this.getAllSelectedFilesAndFields=function(e){var t={},n=e.fileData;for(var a in n)if(n.hasOwnProperty(a)){var r=n[a];if(r.selected){var i=r.selectedItems;VESPER.log("selected items",i);var o={},l=0;for(var s in i)i.hasOwnProperty(s)&&i[s]&&(o[s]=!0,l++);if(l){var c=r.invFieldIndex[r.idIndex];o[c]=!0,t[a]=o}}}return VESPER.log("Selected File and Fields Structure",t),t},this.setAllFields=function(e,t,n,a,r,l){for(var s=e.selectAll("table"),c=l?l.useExtRows:!0,d=l?l.selectFirstOnly:!1,u=r.fileData,p=d3.entries(u).sort(function(e,t){return"core"===e.key?-1:"core"===t.key?1:0}),h=n?n.slice(0):void 0,f=0;f<p.length;f++){var v=p[f].value,g=v.selectedItems,m=h||v.invFieldIndex;if(void 0!==g){for(var E=0;E<m.length;E++){var S=m[E];v.fieldIndex[S]&&(g[S]=0===f||c?(a?a(v,S):!1)||t:!1,t&&d&&h&&(h[E]=null))}var y=d3.values(g),x=d3.set(y);i(v,x.has("true"))}}i(VESPER.DWCAParser.getFileDatum(r,!0),!0),s.each(function(e){o(d3.select(this),r,e.key)})},this.fieldListExistence=function(e,t,n,a,r,i){var o=d3.set(t),l=d3.set(),s=i?"filteredInvFieldIndex":"invFieldIndex",c=[];for(var d in e.fileData)if(e.fileData.hasOwnProperty(d)){var u=e.fileData[d];if(r||"core"===d)for(var p=0;p<u[s].length;p++){var h=u[s][p];o.has(h)&&(l.add(h),c.push({fieldName:h,rowName:d}))}}VESPER.log("Field List",t,"Match",c,l.values());var f=l.values().length,v=n?f===t.length:a?f>=a:f>0;return{match:v,fields:c}},this.addHelperButton=function(e,n,a,r,i,o,s,c,d){var u=e.selectAll("button[type=button]."+s).data([{key:a,value:r,add:i}],function(e){return e.key});u.enter().append("button").attr("type","button").attr("class",s).attr("value",function(e){return e.key}).attr("name",function(e){return e.key}).on("click",function(e){l.setAllFields(n,e.add,e.value,t,c(),d)}).html(function(e){return(o?'<img src="'+o+'">':"")+e.key})},this.addCheckboxes=function(e,t,n){function a(e){return e.title||e.name}function r(e){(e.icon||e.image)&&d3.select(this).append("img").attr("class","vesperIcon").attr("alt",a).attr("src",function(e){return e.image||e.icon})}var i=e.selectAll("span").data(t,function(e){return e.title});if(!i.enter().empty()){var o=i.enter().append("span").attr("class",n);o.append("input").attr("type","checkbox").attr("value",a).attr("name",a).attr("id",a).property("checked",!1);var l=o.append("label").attr("for",a);l.each(r),l.append("span").text(a)}return i},this.reselectActiveVisChoices=function(e,n,a,r){e=e.filter(function(){return d3.select(this).property("checked")});var i=[];return e.each(function(e){i.push.apply(i,e.attList)}),l.setAllFields(n,!0,i,t,a(),r),e},this.addRadioButtons=function(e,t,n,a,r,i){var o=e.selectAll("span").data(t,function(e){return r(e)});if(!o.enter().empty()){var l=o.enter().append("span").attr("class",n);l.append("input").attr("type","radio").attr("name",a).attr("id",function(e){return r(e)+"RBChoice"}).property("checked",!1),l.append("label").attr("for",function(e){return r(e)+"RBChoice"}).text(i)}return o},this.configureRadioButtons=function(e,n,a,r,i){e.selectAll("input").on("click",function(e){var o=d3.select(this).property("checked"),s=d3.select(this).attr("name"),c=d3.selectAll("input[type='radio'][name='"+s+"']"),d=[];c.each(function(e){d.push(e.fieldType)}),l.setAllFields(n,!1,d,t,r(),i),l.setAllFields(n,o,[e.fieldType],t,r(),i),a(e)})},this.makeProgressBar=function(e,t,n){var a=d3.select("#"+t);return a.empty()&&e&&e.append("div").attr("id",t),a=d3.select("#"+t),a.empty()||(a.attr("class",n),a.select("p").empty()&&a.append("p")),a},this.addDragArea=function(e){if(e){var t=e.attr("id");e.append("div").attr("class","dragHandle").attr("id",t+"dragger")}},this.twiceUpRemove=function(e){var t=d3.select(e).node(),n=t.parentElement;$(function(){$(n).draggable("destroy")}),n.parentElement.removeChild(n)},this.recurseClearEvents=function(e){e.on("mouseout",null).on("mouseover",null).on("mousedown",null).on("mouseup",null).on("mousemove",null).on("click",null).on("dblclick",null).on("contextmenu",null),e.each(function(){var e=d3.select(this),t=e.selectAll("*");t.empty()||l.recurseClearEvents(t)})},l},VESPER.DWCAMapLeaflet=function(e){function t(){var e=d._topClusterLevel.getChildCount(),t=Math.log(e+1);m=g/t}function n(e,t,n){var a,r,i,o,l=!1;if(!t.contains(n))return!1;
for(i=0,o=e.length;o>i;i++)a=e[i],r=e[(i-1+o)%o],a.lat>n.lat!=r.lat>n.lat&&n.lng<(r.lng-a.lng)*(n.lat-a.lat)/(r.lat-a.lat)+a.lng&&(l=!l);return l}L.Icon.Default.imagePath="../lib/leafletjs/images/";var a,r,i,o,l,s,c,d,u,p,h=this,f=e.substring(1),v={},g=60,m=5,E=new L.Icon.Default;E.options.iconUrl=VESPER.imgbase+"selMarker.png",E.options.shadowUrl=L.Icon.Default.imagePath+"marker-shadow.png";var S=new L.Icon.Default,y=d3.format(".6r"),x=d3.format(","),P=function(e){return isNaN(e)?e:x(e)},R=function(e){var t=e.layer.getSelectedChildCount();VESPER.tooltip.updateText($.t("map.tooltipHeader",{count:e.layer.getChildCount()}),(t>0?$.t("map.tooltipSel",{count:t}):"")+$.t("map.tooltipCluster")+$.t("map.tooltipLatLong",{lat:y(e.latlng.lat),llong:y(e.latlng.lng)})).updatePosition(e.originalEvent)},D=function(e){var t=[],n=[];if(e.layer.getAllChildMarkers(t),t.length>0){for(var a=t.length;--a>=0;)n.push(t[a].extId);l.getSelectionModel().clear(),l.getSelectionModel().addAllToMap(n)}},T=function(e){var t=e.target.extId,n=l.getNodeFromID(t);VESPER.tooltip.updateText(l.getLabel(n),(l.getSelectionModel().contains(t)?$.t("map.tooltipIndSel"):"")+$.t("map.tooltipID",{dwcaId:t})+$.t("map.tooltipLatLong",{lat:y(e.latlng.lat),llong:y(e.latlng.lng)})).updatePosition(e.originalEvent)},b=function(e){l.getSelectionModel().clear(),l.getSelectionModel().addToMap(e.target.extId)},V=function(e){var t=e.layerType,a=e.layer,r=[];if("circle"===t){VESPER.log("circle",e);var i=e.layer._latlng,o=e.layer._mRadius;d.eachLayer(function(e){var t=e.getLatLng();i.distanceTo(t)<=o&&r.push(e.extId)})}else if("rectangle"===t){VESPER.log("rectangle",e);var c=e.layer._latlngs,u=new L.LatLngBounds(c[0],c[2]);d.eachLayer(function(e){var t=e.getLatLng();u.contains(t)&&r.push(e.extId)})}else if("polygon"===t){VESPER.log("polygon",e);var c=e.layer._latlngs,p=new L.LatLngBounds(c);d.eachLayer(function(e){var t=e.getLatLng();n(c,p,t)&&r.push(e.extId)})}VESPER.log(r.length,"specimens within",t),s=a,l.getSelectionModel().clear(),l.getSelectionModel().addAllToMap(r)};this.set=function(t,n){var s=n.makeIndices([t.identifyingField,t.longitude,t.latitude]);r=s[0],i=s[1],o=s[2],a=MGNapier.NapVisLib.getDivDims(e),l=n,VESPER.log("set model for map",l)},this.go=function(){if(!p){var n="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",a="Map data � OpenStreetMap contributors",r=new L.TileLayer(n,{minZoom:1,maxZoom:19,attribution:a,attributionControl:!1});d3.select(e).style("overflow","hidden"),p=L.map(f),p.addLayer(r);var s=new L.Control.Draw({draw:{marker:!1,polyline:!1}});p.addControl(s),p.on("draw:created",V),d=new L.MarkerClusterGroup({iconCreateFunction:function(e){var t=Math.log(e.getChildCount()+1),n=10+t*m,a=n*Math.log(e.getSelectedChildCount()+1)/t,r=n-a;return a=Math.round(a),r=.5>r?e.getChildCount()===e.getSelectedChildCount()?0:1:Math.round(r),n=a+r,new L.DivIcon({html:'<div class="unselected" style="height:'+r+'px;">'+P(e.getChildCount())+'</div><div class="selected" style="height:'+a+'px">'+P(e.getSelectedChildCount())+"</div>",className:"vesperMapIcon",iconSize:new L.Point(40,n)})}}),d.on("clustermouseover",R).on("clustermouseout",function(){VESPER.tooltip.setToFade()}).on("clustercontextmenu",D)}var g=[],E=[],S=l.getData();if(o&&i){var y=[],x=[];for(var A in S)if(S.hasOwnProperty(A)){y.length=0,x.length=0,l.getIndexedDataPoints(S[A],o,y),l.getIndexedDataPoints(S[A],i,x);for(var C=y.length;--C>=0;){var w=+y[C],k=+x[C];if(!isNaN(w)&&!isNaN(k)){var I=[w,k],N=L.marker(I).on("mouseover",T).on("mouseout",function(){VESPER.tooltip.setToFade()}).on("contextmenu",b);if(N.extId=A,E.push(N),g.push(I),v[A]){var F=v[A];if(F.extId){var M=[F];v[A]=M,F=M}F.push(N)}else v[A]=N}}}d.addLayers(E)}p.addLayer(d),p.fitBounds(new L.LatLngBounds(g).pad(1.05));var $=L.TileLayer.maskCanvas({opacity:.6,radius:4,useAbsoluteRadius:!1,color:"#aaf",noMask:!0,lineColor:"#66a"});$.setData(g),c=L.TileLayer.maskCanvas({opacity:.8,radius:4,useAbsoluteRadius:!1,color:"#f00",noMask:!0,lineColor:"#a00"}),c.setData([]),u=L.layerGroup([$,c]),L.control.layers({},{"Marker Group":d,"Direct Plot":u}).addTo(p),L.control.scale().addTo(p),VESPER.log("group ",d),VESPER.log("map ",p),t(),h.update()},this.resized=function(){d3.select(e).style("height","95%"),p.invalidateSize(),a=MGNapier.NapVisLib.getDivDims(e),this.update()},this.update=function(){var e=l.getSelectionModel().values();if(d){t(),d.eachLayer(function(e){var t=l.getSelectionModel().contains(e.extId);e.setIcon(t?E:S)});for(var n,a=[],r=0,i=e.length;i>r;r++){var o=v[e[r]];if(o)if(o.extId)a.push(o.getLatLng()),n=o;else for(var s=o.length;--s>=0;){var u=o[s];a.push(u.getLatLng()),n=u}}if(d.setAllSelectedChildCounts(l.getSelectionModel()),1===a.length)d.zoomToShowLayer(n,function(){n.openPopup()});else if(a.length>1){var h=new L.LatLngBounds(a);p.fitBounds(h)}c.setData(a)}},this.destroy=function(){p.addLayer(d),p.addLayer(u),l.removeView(h),l=null,d.removeEventListener(),d.eachLayer(function(e){e.removeEventListener()}),d.clearAllChildClusters(),d.clearLayers(),u.eachLayer(function(e){e.removeEventListener(),e.setData([])}),u.clearLayers();var t=[];p.eachLayer(function(e){t.push(e)}),p.removeEventListener();for(var n=0;n<t.length;n++)p.removeLayer(t[n]);p.remove(),v={},VESPER.DWCAHelper.twiceUpRemove(e)},this.updateVals=this.update,L.MarkerClusterGroup.include({setAllSelectedChildCounts:function(e){return this._topClusterLevel.setAllSelectedChildCounts(e)},clearAllChildClusters:function(){this._topClusterLevel.clearChildClusters()}}),L.MarkerCluster.include({_selChildCount:0,setAllSelectedChildCounts:function(e){for(var t=0,n=this._markers.length;--n>=0;)e.contains(this._markers[n].extId)&&t++;for(var a=this._childClusters.length;--a>=0;)t+=this._childClusters[a].setAllSelectedChildCounts(e);return this._selChildCount=t,this._updateIcon(),t},getSelectedChildCount:function(){return this._selChildCount},clearChildClusters:function(){for(var e=this._childClusters.length;--e>=0;)this._childClusters[e].clearChildClusters();this._childClusters.length=0}})},VESPER.DWCAParser=new function(){function e(e,t,n,a){VESPER.log("SELECTED STUFF",n,a),$.each(n,function(n){var r=t.fileData[n],i=e.dwcaFolder+r.fileName;e.zipEntries.getLocalFile(i).uncompressedFileData=null,a[r.fileName].length=0,a[r.fileName]=null}),e.zipEntries.reader.stream=null,VESPER.alerts&&alert("mem monitor point 1")}function t(e){var t=o[e];return void 0===t?e:t}function n(e,t,n){e[t]||(e[t]=[]),e[t].push(n)}function a(e,t){if(void 0==e.filteredFieldIndex[t]){var n=e.filteredInvFieldIndex.length;e.filteredInvFieldIndex.push(t),e.filteredFieldIndex[t]=n,n=e.invFieldIndex.length,e.invFieldIndex.push(t),e.fieldIndex[t]=n}}function r(e){var t=e?e.lastIndexOf("/")+1:-1;return t>0?e.substring(t):e}this.TDATA=0,this.TAXA=1,this.EXT=2,this.SYN=3,this.PID=4,this.SPECS="s",this.DCOUNT="dct",this.SYNCOUNT="syct",this.SPECCOUNT="spct",this.SEL_DCOUNT="Sdct",this.SEL_SYNCOUNT="Ssyct",this.SEL_SPECCOUNT="Sspct",this.SUPERROOT="superroot";var i="-1000",o={"class":"classs",DarwinCore:"Occurrence",SimpleDarwinCore:"Occurrence",catalogNumberNumeric:"catalogNumber",collectorNumber:"recordNumber",collector:"recordedBy",nativeness:"establishmentMeans",latestDateCollected:"eventDate",earliestDateCollected:"eventDate",state:"stateProvince",province:"stateProvince",city:"municipality",depth:"verbatimDepth",elevation:"verbatimElevation",latitude:"decimalLatitude",longitude:"decimalLongitude",datum:"geodeticDatum",nameUsageID:"taxonID",nameID:"scientificNameID",individualID:"organismID",acceptedTaxonID:"acceptedNameUsageID",parentTaxonID:"parentNameUsageID",higherTaxonID:"parentNameUsageID",higherNameUsageID:"parentNameUsageID",originalNameID:"originalNameUsageID",originalTaxonID:"originalNameUsageID",basionymID:"originalNameUsageID",taxonAccordingToID:"nameAccordingToID",acceptedTaxon:"acceptedNameUsage",parentTaxon:"parentNameUsage",higherTaxon:"parentNameUsage",higherTaxonName:"higherClassification",higherNameUsage:"parentNameUsage",originalName:"originalNameUsage",originalTaxon:"originalNameUsage",basionym:"originalNameUsage",taxonAccordingTo:"nameAccordingTo",rank:"taxonRank",scientificNameRank:"taxonRank",taxonRemark:"taxonRemarks",EventAttributeType:"measurementType",eventMeasurementType:"measurementType",SamplingAttributeType:"measurementType"};this.flabbyLists={},this.flabbyLists.wordyList=["eventRemarks","taxonRemarks","georeferenceRemarks","identificationRemarks","locationRemarks","measurementRemarks","occurrenceRemarks","relationshipRemarks","verbatimCoordinates","bibliographicCitation","description"],this.GBIFRanks=["domain","kingdom","subkingdom","superphylum","phylum","subphylum","superclass","class","subclass","supercohort","cohort","subcohort","superorder","order","suborder","infraorder","superfamily","family","subfamily","tribe","subtribe","genus","subgenus","section","subsection","series","subseries","speciesAggregate","species","subspecificAggregate","subspecies","variety","subvariety","form","subform","cultivarGroup","cultivar","strain"],this.explicitRanks=["kingdom","phylum","classs","order","family","genus","subgenus","specificEpithet","infraspecificEpithet"],this.neccLists={},this.neccLists.geo=["decimalLatitude","decimalLongitude","geodeticDatum"],this.neccLists.impTaxonomy=["acceptedNameUsageID","parentNameUsageID","taxonRank"],this.neccLists.expTaxonomy=this.explicitRanks,this.neccLists.times=["eventDate","modified","geodeticDatum","georeferencedDate","dateIdentified","verbatimEventDate"],this.neccLists.basicTimes=["eventDate"],this.labelChoiceData=["acceptedNameUsage","scientificName","originalNameUsage","vernacularName"],this.controlledVocabFields=["continent","country","countryCode","stateProvince","county","island","islandGroup","waterBody","higherGeographyID","geodeticDatum","georeferenceVerificationStatus","verbatimCoordinateSystem","verbatimSRS","taxonomicStatus","language","nomenclaturalCode","nomenclaturalStatus","identificationVerificationStatus","rightsHolder","type","audience","format","taxonRank","verbatimTaxonRank","basisOfRecord","dcterms:type","dcterms:language","measurementUnit","behavior","relationshipOfResource","establishmentMeans","occurrenceStatus","disposition","sex","lifeStage","reproductiveCondition","isPlural","threatStatus","isMarine","isFreshwater","isTerrestrial","isInvasive","isHybrid","isExtinct","typeDesignationType"],this.archiveLimitedFields=["institutionID","collectionID","datasetID","institutionCode","collectionCode","datasetName","ownerInstitutionCode","year","month","day","source","nameAccordingToID","isPreferredName","typeStatus","verbatimTaxonRank","superkingdom","kingdom","superphylum","phylum","subphylum","superclass","classs","order","family"],this.controlledVocabSet={};for(var l=0;l<this.controlledVocabFields.length;l++)this.controlledVocabSet[this.controlledVocabFields[l]]=!0;this.discreteTermList=this.controlledVocabFields.concat(this.archiveLimitedFields),this.discreteTermSet={};for(var l=0;l<this.discreteTermList.length;l++)this.discreteTermSet[this.discreteTermList[l]]=!0;return this.sharedValuesTerms={taxonID:1,acceptedNameUsageID:1,parentNameUsageID:1,originalNameUsageID:1},this.recordURIMap={"http://rs.tdwg.org/dwc/xsd/simpledarwincore/SimpleDarwinRecord":"Simple Darwin Record","http://rs.tdwg.org/dwc/terms/Occurrence":"Occurrence","http://rs.tdwg.org/dwc/terms/Event":"Event","http://purl.org/dc/terms/Location":"Location","http://purl.org/dc/terms/GeologicalContext":"GeologicalContext","http://rs.tdwg.org/dwc/terms/Identification":"Identification","http://rs.tdwg.org/dwc/terms/Taxon":"Taxon","http://rs.tdwg.org/dwc/terms/ResourceRelationship":"ResourceRelationship","http://rs.tdwg.org/dwc/terms/MeasurementOrFact":"MeasurementOrFact","http://rs.gbif.org/terms/1.0/Distribution":"Distribution","http://rs.gbif.org/terms/1.0/VernacularName":"VernacularName","http://rs.gbif.org/terms/1.0/SpeciesProfile":"SpeciesProfile","http://rs.gbif.org/terms/1.0/TypesAndSpecimen":"TypesAndSpecimen","http://rs.gbif.org/terms/1.0/Reference":"Reference","http://rs.gbif.org/terms/1.0/Image":"Image","http://rs.gbif.org/terms/1.0/Identifier":"Identifier","http://rs.gbif.org/terms/1.0/Description":"Description","http://rs.nordgen.org/dwc/germplasm/0.1/terms/GermplasmSample":"GermplasmSample","http://purl.org/germplasm/germplasmTerm#GermplasmAccession":"GermplasmAccession","http://purl.org/germplasm/germplasmTerm#MeasurementExperiment":"MeasurementExperiment","http://purl.org/germplasm/germplasmTerm#MeasurementMethod":"MeasurementMethod","http://eol.org/schema/reference/Reference":"EOL Reference","http://eol.org/schema/media/Document":"EOL Document","http://eol.org/schema/agent/Agent":"EOL Agent","http://www.w3.org/ns/oa#Annotationt":"W3 Annotation","http://rs.gbif.org/terms/1.0/Multimedia":"Multimedia"},this.rowTypeDefaults={},this.fieldAttrNames={},this.xsd=null,this.loadxsd=function(e){return $.get(e,function(e){VESPER.log("LOADED XSD",e,typeof e),VESPER.DWCAParser.xsd=$("string"==typeof e?MGNapier.NapVisLib.parseXML(e):e),VESPER.DWCAParser.makeRowTypeDefaults(VESPER.DWCAParser.xsd),VESPER.DWCAParser.makeFieldAttrNames(VESPER.DWCAParser.xsd)})},this.accessZip=function(e,t){var n=new JSZip(e,{base64:!1,noInflate:!0});n.dwcaFolder="";for(var a,r=0;r<n.zipEntries.files.length;r++){var i=n.zipEntries.files[r].fileName,o=i.indexOf(t);if(o>=0){a=i,n.dwcaFolder=a.slice(0,o);break}}if(VESPER.log("ZIP ENTRIES",n.zipEntries,a),void 0!==a){n.zipEntries.readLocalFile(a),VESPER.log("unzipped ",n,n.files);var l=n.zipEntries.getLocalFile(a),s=VESPER.DWCAParser.parseMeta($.parseXML(l.uncompressedFileData));return{jszip:n,meta:s}}return{jszip:n,meta:{error:$.t("parser.zipError",{file:t})}}},this.filterReadZipEntriesToMakeModel=function(t,n,a){function r(c){var d=l[s].key,u=l[s].value,p=n.fileData[d],h=t.dwcaFolder+p.fileName,f=MGNapier.NapVisLib.newFilledArray(p.invFieldIndex.length,!1);$.each(u,function(e,t){f[p.fieldIndex[e]]=t}),VESPER.DWCAZipParse.set(p,f),c.callbackQ=[],c.fileName=h;var v=function(){o[p.fileName]=t.zipEntries.getLocalFile(h).uncompressedFileData,VESPER.DWCAParser.updateFilteredLists(p,f,t.zipEntries.getLocalFile(h)),s===l.length-1&&(a(new VESPER.DWCAModel(n,VESPER.DWCAParser.setupStrucFromRows(o,n))),e(t,n,i,o)),c.callbackQ.length=0,c.fileName=void 0,s++,s<l.length&&r(c)};c.callbackQ.push(v),t.zipEntries.readLocalFile(h,c)}var i=VESPER.DWCAHelper.getAllSelectedFilesAndFields(n),o={},l=d3.entries(i),s=0;r(VESPER.DWCAZipParse.zipStreamSVParser2)},$.fn.filterNode=function(e){return this.find("*").filter(function(){return this.nodeName?this.nodeName.toUpperCase()===e.toUpperCase():!1})},this.makeRowTypeDefaults=function(e){var t=e.find('xs\\:attributeGroup[name="fileAttributes"], attributeGroup[name="fileAttributes"]'),n=$(t);$(n[0]).find("xs\\:attribute, attribute").each(function(){var e=$(this),t=e.attr("default"),n=e.attr("type");"xs:integer"==n&&(t=+t),VESPER.DWCAParser.rowTypeDefaults[e.attr("name")]=t}),VESPER.log("Row Type Defaults",VESPER.DWCAParser.rowTypeDefaults)},this.makeFieldAttrNames=function(e){var t=e.find('xs\\:complexType[name="fieldType"], complexType[name="fieldType"]'),n=$(t);$(n[0]).find("xs\\:attribute, attribute").each(function(){var e=$(this),t=e.attr("name"),n=e.attr("type");VESPER.DWCAParser.fieldAttrNames[t]=n}),VESPER.log("Field Attribute Names",VESPER.DWCAParser.fieldAttrNames)},this.occArray2JSONArray=function(e,t){var n={};VESPER.alerts&&alert("mem monitor point 1.4");for(var a=0,r=e.length;r>a;a++){var i=e[a];if(i){var o=i[t];n[o]={},n[o][this.TDATA]=i}}return n},this.jsonTaxaObj2JSONTree=function(e,t,a,r){var i=a.filteredFieldIndex,o=a.idIndex;VESPER.alerts&&alert("mem monitor point 1.5");for(var l=i.parentNameUsageID,s=i.acceptedNameUsageID,c=0,d=t.length;d>c;c++){var u=t[c];if(u){var p=u[o],h=u[l],f=e[h];h!==p&&f&&n(f,VESPER.DWCAParser.TAXA,e[p])}}for(var c=0,d=t.length;d>c;c++){var u=t[c];if(u){var p=u[o],h=u[l],f=e[h];if(void 0==f){var v=u[s];if(v&&p!==v){var g=e[v];if(g){var m=e[p];n(g,VESPER.DWCAParser.SYN,m);var E=m[VESPER.DWCAParser.TAXA];if(E){for(var S=0;S<E.length;S++){var y=E[S],x=y[VESPER.DWCAParser.TDATA],P=x[o],R=x[s];P===R&&void 0!==R&&n(g,VESPER.DWCAParser.TAXA,y)}m[VESPER.DWCAParser.TAXA].length=0}}else VESPER.log($.t("parser.deadonymError",{aid:v,rec:u}))}}}}var D=this.findRoots(e,o,i),T=this.createSuperroot(e,D,a,r,i);return VESPER.log("roots",D),VESPER.log("JSON",e[1],e),{tree:e,root:T}},this.jsonTaxaObj2ExplicitJSONTree=function(e,t,r,o,l){a(r,"taxonRank");var s=r.idIndex,c=r.filteredFieldIndex;VESPER.alerts&&alert("mem monitor point 1.5a ex"),VESPER.log("SPECS",VESPER.DWCAParser.SPECS);var d=VESPER.DWCAParser.explicitRanks;VESPER.log("Vesper adds",o.vesperAdds);var u=c[o.vesperAdds.nameLabelField.fieldType],p={},h=d.length,f={};VESPER.log("tsvdata",t,t[0],t[1]);for(var v=[],g=[],m=0;h>m;m++){var E=d[m];("specificEpithet"===E||"infraspecificEpithet"===E)&&(v[m]=!0),g[m]=c[E]}for(var S=0,y=t.length;y>S;S++){var x=t[S];if(x){for(var P=!1,R=void 0,D=void 0,m=0;h>m;m++){var E=d[m],T=g[m];if(T){var b=x[T];if(b){v[m]&&R&&(b=R[this.TDATA][u]+" "+b);var V=b;if(f[V]){var A=R?R[this.TDATA][s]:i,C=f[V][this.PID];A!==C&&(V=A+V,f[V]||VESPER.log("Introducing new id",V))}if(!f[V]){var w=[];w[s]=V,w[u]=b,w[c.taxonRank]=E;var k={};k[this.TDATA]=w,f[V]=k,R&&n(R,VESPER.DWCAParser.TAXA,k),k[this.PID]=R?R[this.TDATA][s]:i}R||(p[V]=!0),P&&VESPER.log("trace",V,b,T,f[V]),R=f[V],D=V}}}R&&(P&&console.log("adding original",e[x[s]],x[u]),l(R,e[x[s]],f,D,s,c,u))}}var L=d3.keys(p),I=this.createSuperroot(f,L,r,o,c);return VESPER.log("roots",L),VESPER.log("json",e,"tree",f),VESPER.log("root",I),{tree:f,root:I}},this.addOriginalAsSpecimenEntry=function(e,t,a,r,i,o,l){var s=r;if(!a[s]){var c=[];c[i]=s,c[l]=s,c[o.taxonRank]="Species";var d={};d[VESPER.DWCAParser.TDATA]=c,a[s]=d,e&&n(e,VESPER.DWCAParser.TAXA,a[s])}n(a[s],VESPER.DWCAParser.SPECS,t)},this.addOriginalAsLeaf=function(e,t){n(e,VESPER.DWCAParser.TAXA,t)},this.addExtRows2JSON=function(e,t,a){var r=a.idIndex,i=[];if(t&&void 0!=r)for(var o=a.extIndex,l=0,s=t.length;s>l;l++){var c=t[l];if(c){var d=c[r];if(void 0!=d){var u=e[d];if(u){u[this.EXT]||(u[this.EXT]=[]);var p=u[this.EXT];n(p,o,c)}}else i.push(l)}}return i},this.getFileRowName=function(e,t,n){var a=this.getFileDatum(e,t,n);return a?a.fileName:void 0},this.makeTreeFromAllFileRows=function(e,t){var n,a,r=t.fileData,i=this.getFileDatum(t,!0),o=e[i.fileName],l=this.occArray2JSONArray(o,i.idIndex),s=VESPER.DWCAHelper.fieldListExistence(t,VESPER.DWCAParser.neccLists.impTaxonomy,!0,void 0,!0,!0),c=VESPER.DWCAHelper.fieldListExistence(t,VESPER.DWCAParser.neccLists.expTaxonomy,!1,2,!0,!0);VESPER.log("TREE POS",s,c),VESPER.log("MDR",t.coreRowType),s.match&&(n=this.jsonTaxaObj2JSONTree(l,o,i,t)),c.match&&(a=this.jsonTaxaObj2ExplicitJSONTree(l,o,i,t,VESPER.DWCAParser.addOriginalAsSpecimenEntry));var d={records:l,impTree:n,expTree:a};for(var u in r)if(r.hasOwnProperty(u)){var p=r[u];if("core"!==u&&p.selected){var h=this.addExtRows2JSON(d.records,e[p.fileName],p);VESPER.log("unreconciled in ",u,h)}}return d},this.setupStrucFromRows=function(e,t){var n=this.makeTreeFromAllFileRows(e,t);return VESPER.alerts&&alert("mem monitor point 2"),n.impTree&&n.impTree.root&&(VESPER.log("root",n.impRoot),this.recursiveCount(n.impTree.root,this.DCOUNT,void 0,1),this.recursiveCount(n.impTree.root,this.SYNCOUNT,VESPER.DWCAParser.SYN,0)),n.expTree&&n.expTree.root&&(this.recursiveCount(n.expTree.root,this.DCOUNT,void 0,1),this.recursiveCount(n.expTree.root,this.SPECCOUNT,VESPER.DWCAParser.SPECS,0)),VESPER.log("STRUC",n),VESPER.alerts&&alert("mem monitor point 3"),VESPER.log("root",n.impTree,n.expTree),n},this.findRoots=function(e,t,n){var a=[],r=n.parentNameUsageID,i=n.acceptedNameUsageID;if(void 0!==i&&void 0!==r)for(var o in e)if(e.hasOwnProperty(o)){var l=e[o],s=l[this.TDATA];if(s){var c=s[t],d=s[i],u=s[r];c!==d&&void 0!=d||u!==c&&void 0!=e[u]||a.push(o)}}return a},this.createSuperroot=function(e,t,n,a,r){if(0===t.length)return void 0;if(1===t.length)return e[t[0]];var o=n.invFieldIndex[n.idIndex],l=r.parentNameUsageID,s={acceptedNameUsageID:i,parentNameUsageID:i,acceptedNameUsage:VESPER.DWCAParser.SUPERROOT,taxonRank:VESPER.DWCAParser.SUPERROOT,nameAccordingTo:"dwcaParse.js"};s[a.vesperAdds.nameLabelField.fieldType]=VESPER.DWCAParser.SUPERROOT,s[o]=i,VESPER.log("SR",s);var c={};c[this.TAXA]=[];for(var d=0;d<t.length;d++)c[this.TAXA].push(e[t[d]]),e[t[d]][VESPER.DWCAParser.TDATA][l]=i;c[VESPER.DWCAParser.TDATA]=[];for(var u in s)s.hasOwnProperty(u)&&void 0!==r[u]&&(c[VESPER.DWCAParser.TDATA][r[u]]=s[u]);return VESPER.log("superroot",c),e[i]=c,c},this.recursiveCount=function(e,t,n,a){var r=0,i=e[this.TAXA];if(i)for(var o=i.length;--o>=0;)r+=this.recursiveCount(i[o],t,n,a);return r+=n&&e[n]?e[n].length:0,(r||e[t])&&(e[t]=r),r+a},this.parseMeta=function(e){var t={},n=this.getCoreRowType(e);t.core=this.parseCore(e,n);for(var a=this.getExtensionRowTypes(e),r=0;r<a.length;r++)t["ext"+r]=this.parseExtension(e,a[r],r);var i={fileData:t,vesperAdds:{}},o=this.getFileDatum(i,!0);return void 0==o?i.error=$.t("parser.missingCoreError"):o.error&&(i.error=o.error),console.log("metaData",i),i},this.getFileDatum=function(e,t,n){return e?t?e.fileData.core:e.fileData["ext"+n]:void 0},this.parseCore=function(e,t){return this.parseFrag(e,'archive core[rowType="'+t+'"]',"id",t)},this.parseExtension=function(e,t,n){var a=this.parseFrag(e,'extension[rowType="'+t+'"]',"coreid",t);return a.extIndex=n,a},this.parseFrag=function(e,n,a,i){VESPER.log("thexml",typeof e,e);var o=$(e).find(n);if(void 0!==o[0]){var l=$(o[0]),s={},c=l.find("files location").contents();if(void 0!==c[0]){s.fileName=c[0].data,s.rowType=i,s.mappedRowType=this.recordURIMap[i]||i;for(var d in this.rowTypeDefaults)this.rowTypeDefaults.hasOwnProperty(d)&&(s[d]=void 0!==l.attr(d)?l.attr(d):this.rowTypeDefaults[d],VESPER.log("att",d,"#",s[d],"#"));VESPER.log(l.attr("fieldsEnclosedBy"));var u=+l.find(a).attr("index");s.idIndex=u;var p=l.find("field");VESPER.log("fieldsTerminatedBy",s.fieldsTerminatedBy),s.fieldIndex={},s.invFieldIndex=[],s.fieldData={},s.fieldIndex[a]=u,s.invFieldIndex[u]=a;for(var h=0;h<p.length;h++){var f=$(p[h]),v={};for(var g in VESPER.DWCAParser.fieldAttrNames)if(VESPER.DWCAParser.fieldAttrNames.hasOwnProperty(g)){var m=VESPER.DWCAParser.fieldAttrNames[g],E=f.attr(g);"xs:integer"==m&&(E=+E),v[g]=E}v.shortTerm=t(r(v.term));var S=v.index,y=v.shortTerm;v.discreteTermList=VESPER.DWCAParser.discreteTermSet[y]?{}:void 0,isNaN(S)||(s.fieldIndex[y]=S,s.invFieldIndex[s.fieldIndex[y]]=y),s.fieldData[y]=v}return s.filteredFieldIndex={},s.filteredInvFieldIndex=[],VESPER.log("filenames: ",c),s}return{error:$.t("parser.missingFilesError",{part:n})}}return{error:$.t("parser.missingPathError",{path:n})}},this.updateFilteredLists=function(e,t){var n=0;e.filteredInvFieldIndex.length=0;var a=e.invFieldIndex[e.idIndex];$.each(e.filteredFieldIndex,function(t){t!==a&&(e.filteredFieldIndex[t]=void 0)});for(var r=0;r<t.length;r++)if(t[r]){var i=e.invFieldIndex[r];e.filteredFieldIndex[i]=n,e.filteredInvFieldIndex[n]=i,n++}VESPER.log("fi",e.fieldIndex,e.filteredFieldIndex,e.invFieldIndex,e.filteredInvFieldIndex)},this.getCoreRowType=function(e){var t=$(e).find("core"),n=$(t[0]).attr("rowType");return VESPER.log("core",n),n},this.getExtensionRowTypes=function(e){for(var t=$(e).find("extension"),n=[],a=0;a<t.length;a++){var r=$(t[a]).attr("rowType");n.push(r)}return n},this.getFilteredIdIndex=function(e){var t=this.getFileDatum(e,!0);return t.filteredFieldIndex[t.invFieldIndex[t.idIndex]]},this.selectNodes=function(e,t,n,a){var r=0;if(void 0!==e){var i=n.getData();for(var o in i)if(i.hasOwnProperty(o)){var l=i[o],s=t(n,l,e);s&&(r++,a(o))}}return r},this.init=function(e){$.when(this.loadxsd("dwca.xsd"),$.get("dwc_occurrence.xml",function(e){VESPER.log("XML LOADED",typeof e),VESPER.DWCAParser.descriptors={};var t=$(e).find("property");VESPER.log("props",t);for(var n=t.length;--n>=0;){var a=$(t[n]);VESPER.DWCAParser.descriptors[a.attr("name")]=a.attr("dc:description")}VESPER.log(VESPER.DWCAParser.descriptors)})).then(e)},this},VESPER.DWCAZipParse=new function(){var e,t,n,a,r,i,o,l,s,c,d,u,p="\\".charCodeAt(0),h=[],f=[],v=[],g=0,m=[],E=[],S=0;return this.rowReader2=function(e){for(var t,a=0,r=0,i=0,s=c[a],u=[],m=e.length,y=!1,x=!1,P=0;m>P;P++){var R=e[P];if(t=R?R:0,o&&!x&&t===l&&(y=!y),!y&&(t===n||P===m-1)){if(s){if(i=P+(t===n?0:1),o&&(e[r]===l&&r++,e[i-1]===l&&i--),r===i)u.push(h[a]);else{var D=String.fromCharCode.apply(null,e.slice(r,i)),T=f[a],b=v[a];if(T){var V=T[D];V?(D=null,D=V):(T[D]=D,VESPER.log("new entry for field",a,"at lineNo",d,":",D,D.length))}else if(b){var V=E[b][D];V?(D=null,D=V):E[b][D]=D}S+=i-r,u.push(D)}t===n&&P===m-1&&u.push(h[a])}a++,s=c[a]|!1,r=P+1}x=t===p}if(d++,(d%1e4===0||10998===d)&&VESPER.log(d,": ",u),d%100===0){var A=MGNapier.NapVisLib.makeTime();A-g>1e3&&(g=A,VESPER.log(d,": ",u))}return u},this.zipStreamSVParser2=function(t){function n(){function g(e,t,n){var o=r===e;if(1===i)return o;if(o){if(n+i<=t.length){for(var l=a.length;--l>=1;)if(a.charCodeAt(l)!==t[n+l])return!1;return c+=a.length-1,!0}b=s-c,c=s,h=void 0}return!1}for(var C=MGNapier.NapVisLib.makeTime();MGNapier.NapVisLib.makeTime()-C<A&&(s=t(m,b,v-b))>0;){s+=b;var w=0;if(b=0,T){var k=String.fromCharCode(m[0])+String.fromCharCode(m[1])+String.fromCharCode(m[2]);VESPER.log("possbom [",k,"]"),"ï»¿"===k&&(VESPER.log("UTF8 bytemark detected"),w=3),T=!1}for(c=w;s>c;c++){if(h=m[c],h>=128)if(h>=194&&224>h)s-1>c?h=((31&h)<<6)+(63&m[++c]):(b=1,c=s,h=void 0);else if(h>=224&&240>h)s-2>c?h=((255&h)<<12)+((63&m[++c])<<6)+(63&m[++c]):(b=s-c,c=s,h=void 0);else if(h>=240&&245>h)if(s-3>c){var L=((7&h)<<18)+((63&m[++c])<<12)+((63&m[++c])<<6)+(63&m[++c]);L-=65536;var I=(1023&L)+56320;h=I.charAt[0],f=I.charAt[1]}else b=s-c,c=s,h=void 0;o&&!R&&h===l?(D=!D,y.push(h)):!D&&g(h,m,c)?(x.push(P>=e.ignoreHeaderLines?VESPER.DWCAZipParse.rowReader2(y):void 0),P++,y.length=0):void 0!==h&&(y.push(h),void 0!==f&&(y.push(f),f=void 0)),R=h===p}if(b)for(var N=0;b>N;N++)m[N]=m[s-b+N]}if(u&&u(VESPER.DWCAZipParse.zipStreamSVParser2.fileName,d),s>0)setTimeout(n,1);else{y.length>0&&x.push(VESPER.DWCAZipParse.rowReader2(y)),V=MGNapier.NapVisLib.makeTime()-V,VESPER.log("Time: ",V/1e3," secs."),VESPER.log("Shared Maps: "+E.length+", "+MGNapier.NapVisLib.countObjProperties(E[1])),VESPER.log("pulled out "+S+" characters from zip"),E.length=0;var F=VESPER.DWCAZipParse.zipStreamSVParser2.callbackQ;VESPER.log("callback queue length",F.length);for(var M=F.length;--M>=0;)F[M](x);y.length=0}}VESPER.alerts&&alert("start partial parse with charcodes");var s,c,h,f,v=1024,m=new Array(v),y=[],x=[],P=0,R=!1,D=!1,T=!0,b=0,V=MGNapier.NapVisLib.makeTime();g=V;var A=200;setTimeout(n,1)},this.setNotifyFunc=function(e){u=e},this.set=function(u,p){e=u,t=u.fieldsTerminatedBy.replace("\\t","	").replace("\\n","\n"),a=u.linesTerminatedBy.replace("\\t","	").replace("\\n","\n").replace("\\r","\r"),o=u.fieldsEnclosedBy.replace('\\"','"'),c=p,s=c.indexOf(!0),n=t.charCodeAt(0),r=a.charCodeAt(0),l=o?o.charCodeAt(0):-1,i=a.length,d=0,VESPER.log(VESPER.DWCAParser.sharedValuesTerms),E.length=0;for(var g=0;g<u.invFieldIndex.length;g++){var S=u.invFieldIndex[g],y=u.fieldData[S];h[g]=y?y.default:void 0,f[g]=y?y.discreteTermList:void 0,v[g]=VESPER.DWCAParser.sharedValuesTerms[S],v[g]&&(E[v[g]]={})}m.length=0;for(var x=0;256>x;x++)m.push(String.fromCharCode(x));VESPER.log("readFields",c),VESPER.log("Q#",o,"#")},this},VESPER.Filters=new function(){return this.nameLabelFilter=function(e,t){var n=new RegExp(t);console.log("regex",n);var a=e.getMetaData(),r=a.vesperAdds.nameLabelField,i=a.fileData[r.rowType],o=i.extIndex,l=i.filteredFieldIndex[r.fieldType],s=[],c=function(e,t,n){var a=e.getRowRecords(t,o);if(void 0==o&&(s[0]=a,a=s),a)for(var r=a.length;--r>=0;){var i=a[r][l];if(i&&n.test(i))return!0}return!1};e.getSelectionModel().setUpdating(!0);var d=e.getParser().selectNodes(n,c,e,function(t){e.getSelectionModel().addToMap(t)});return e.getSelectionModel().setUpdating(!1),d},this.standardRankFilter=function(e){var t=e.getMetaData(),n=e.makeIndex("taxonRank"),a=t.fileData[n.rowType],r=a.extIndex,i=a.filteredFieldIndex[n.fieldType],o=a.fieldData[n.fieldType],l=o.discreteTermList,s=[];e.getParser().GBIFRanks.forEach(function(e){l[e]&&s.push(e)}),VESPER.log("aranks",s);var c=s.length?new RegExp("^("+s.join("|")+")$"):void 0;VESPER.log("regex",c);var d=[],u=function(e,t,n){var a=e.getRowRecords(t,r);if(void 0==r&&(d[0]=a,a=d),a)for(var o=a.length;--o>=0;){var l=a[o][i];if(l&&n.test(l))return!0}return!1};e.getSelectionModel().setUpdating(!0);var p=e.getParser().selectNodes(c,u,e,function(t){e.getSelectionModel().addToMap(t)});return e.invertSelection(),e.getSelectionModel().setUpdating(!1),p},this},VESPER.modelComparisons=new function(){function e(e,t){var n=MGNapier.NapVisLib.countObjProperties(e.getData()),a=MGNapier.NapVisLib.countObjProperties(t.getData());return a>n?e:t}function t(e,t){for(var n=Math.min(e?e.length:0,t?t.length:0),a=0;n>a;a++)if(e[a]!==t[a])return a;return n}function n(e,n,a,r,i,o){var l=n.length;if(a>0){var s=r[a-1],c=Math.min(l,s[1].length),d=t(n,s[1]);d>=10&&d===c&&(i.addToMap(s[0]),o.addToMap(e))}if(a<r.length){var u=r[a],p=Math.min(l,u[1].length),h=t(n,u[1]);h>=10&&h===p&&(i.addToMap(u[0]),o.addToMap(e))}}function a(e,t){for(var n,a,r,i=0,o=e.length-1;o>=i;)if(r=n=(i+o)/2|0,a=e[n][1],t>a)i=n+1;else{if(!(a>t))return n;o=n-1}return~Math.max(o,i)}return this.modelCoverageToSelection=function(t,r,i,o){var l=e(t,r),s=l===t?r:t,c=l===t?i:o,d=l===t?o:i,u=[l.getExplicitTaxonomy(),l.getData()],p=[s.getExplicitTaxonomy(),s.getData()],h=l.getSelectionModel(),f=s.getSelectionModel();h.clear(),f.clear(),h.setUpdating(!0),f.setUpdating(!0);for(var v=[],g=0;g<u.length;g++){var m=u[g];if(m)for(var E in m)if(m.hasOwnProperty(E)){var S=l.getDataPoint(m[E],c);v.push([E,S])}}var y={base:0};MGNapier.NapVisLib.resetStopwatch(y),v.sort(function(e,t){return e[1]<t[1]?-1:e[1]>t[1]?1:0}),VESPER.log("sort",MGNapier.NapVisLib.elapsedStopwatch(y),"ms"),MGNapier.NapVisLib.resetStopwatch(y);for(var x,P,R=0,D=0;D<p.length;D++){var m=p[D];if(m)for(var E in m)if(m.hasOwnProperty(E)){var S=s.getDataPoint(m[E],d),T=x===S?P:a(v,S);x=S,P=T,R++,T>=0?(h.addToMap(v[T][0]),f.addToMap(E)):(T=~T,n(E,S,T,v,h,f))}}VESPER.log("search",MGNapier.NapVisLib.elapsedStopwatch(y),"ms"),VESPER.log("Done",R,"comparisons"),h.setUpdating(!1),f.setUpdating(!1)},this.test1=function(){for(var e=[["345","ant"],["2013","bat"],["45","cat"],["133","dog"],["708","eel"]],t=["rabbit","aardvark","cat","cattus fattus"],n=0;n<t.length;n++)console.log("binary test",t[n],a(e,t[n]))},this},VESPER.FilterView=function(e){function t(){var t=d3.select(e).select("span input");t.on("keyup",function(){(i||13===(d3.event.keyCode|d3.event.charCode))&&(n.getSelectionModel().clear(),VESPER.Filters.nameLabelFilter(n,d3.select(this).property("value")))})}var n,a,r=this,i=!0;this.set=function(e,t){a=e.identifyingField,n=t},this.go=function(){var n=d3.select(e).attr("id")+"Text",a=d3.select(e).append("span");a.append("label").attr("for",n).attr("class","recordEntryLabel").text($.t("search.label")),a.append("input").attr("type","search").attr("id",n).attr("placeholder",$.t("search.placeholderText"));var r=a.append("div");r.append("input").attr("name",n+"TypeAhead").attr("value",i?"checked":"").attr("checked",i).attr("type","checkbox").on("click",function(){i=d3.event.target.checked}),r.append("label").attr("for",n+"TypeAhead").text($.t("search.keystrokeLabel")),t(),this.update()},this.update=function(){},this.updateVals=this.update,this.destroy=function(){VESPER.DWCAHelper.recurseClearEvents(d3.select(e)),n.removeView(r),n=null,VESPER.DWCAHelper.twiceUpRemove(e)}},VESPER.modelBag=[],VESPER.RecordDetails=function(e){function t(e){return e.mappedRowType+":"+e.fileName}function n(t,n,r,i){var o=t.select("."+n);if(o.empty()){d3.select(e).append("table").attr("class",n),o=d3.select(e).select("."+n),a(o,i);var l=o.append("tr").selectAll("th").data(r);l.enter().append("th").text(function(e){return e
})}return o}function a(e,t){var n=e.selectAll("caption").data([t]);n.enter().append("caption"),n.text(function(e){return e})}function r(e){return"ext"+e+"Table"}function i(t){d.getNodeFromID(t)?(u=t,v.update()):d3.select(e).select("div").select("span.vesperWarning").style("display",null)}function o(t){t&&(d3.select(e).select("input").property("value",t),i(t))}function l(e){function t(e){e.substring&&"http://"===e.substring(0,7)?d3.select(this).append("a").attr("href",function(e){return e}).attr("target","_blank").text(function(e){return e}):d3.select(this).text(function(e){return e})}var n=e.selectAll("td").data(function(e){return e});n.enter().append("td"),n.each(t).on("mouseout",function(){VESPER.tooltip.setToFade()}).on("mouseover",function(e){d.getParser().descriptors[e]&&VESPER.tooltip.updateText(e,d.getParser().descriptors[e]).updatePosition(d3.event)}).on("click",o).style("cursor","pointer")}function s(e,n,i,o){var l=d.getMetaData().fileData,s=r(n);VESPER.log("table",o,"#"+s,i);var c=d3.select(o).select("#"+s),u=l[i];a(c,t(u));var p=c.selectAll("tr.hrow"),h=p.data([0]);h.enter().append("tr").attr("class","hrow");var f=l[i].filteredInvFieldIndex;p=c.selectAll("tr.hrow");var v=p.selectAll("th").data(f);v.text(function(e,t){return f[t]}),v.enter().append("th").text(function(e,t){return f[t]})}function c(e,t,n,a){var i=t,o=r(t),l=d3.select(a).select("#"+o),s=l.selectAll("tr.drow"),c=s.data(e[i]);c.exit().remove(),c.enter().append("tr").attr("class","drow").attr("id",function(e,t){return o+t});for(var d=0;d<e[i].length;d++){var u=e[i][d],p=l.select("#"+o+d).selectAll("td"),h=p.data(u);h.exit().text(""),h.text(function(e){return e}),h.enter().append("td").text(function(e){return e})}}var d,u,p,h="extDetailTable",f="detailTable",v=this;this.set=function(e,t){var n=t.makeIndices([e.identifyingField]);p=n[0],d=t},this.go=function(){var t=d3.select(e),n=t.append("div"),a=t.attr("id")+"textinput";n.append("label").attr("for",a).attr("class","recordEntryLabel").text($.t("search.findLabel")),n.append("input").attr("type","search").attr("id",a).attr("placeholder",$.t("search.findPlaceholderText")),n.append("span").attr("class","vesperWarning recordEntryLabel").text($.t("search.noResult")).style("display","none");var r=t.select("input");r.on("keyup",function(){if(n.select("span.vesperWarning").style("display","none"),13===(d3.event.keyCode|d3.event.charCode)){var e=d3.select(this).property("value");i(e)}})},this.update=function(){var a=d3.select(e);if(void 0!==u){for(var i=d.getMetaData(),o=i.fileData,v=d.getNodeFromID(u),g=n(a,f,[$.t("search.fieldLabel"),$.t("search.valueLabel")],t(o.core)),m=[],E=VESPER.DWCAParser.getFileDatum(i,!0).filteredInvFieldIndex,S=d.getTaxaData(v),y=0;y<S.length;y++)S[y]&&m.push([E[y],S[y]]);var x=g.selectAll("tr.nonHeader").data(m);x.exit().remove(),l(x);var P=x.enter().append("tr").attr("class","nonHeader");l(P);var R=d3.keys(d.getExtraData(v)),D=a.selectAll("table."+h).data(R,function(e){return e});D.exit().remove(),D.enter().append("table").attr("class",h).attr("id",r);for(var y=0;y<R.length;y++){var T=R[y],b="ext"+T;s(d.getExtraData(v),R[y],b,e),c(d.getExtraData(v),R[y],b,e)}var V=n(a,"synTable",[$.t("search.recordSyn")],"Synonymy"),A=d.getSynonyms(v);if(m=[],A)for(var y=0;y<A.length;y++){var C=A[y];m.push([d.getIndexedDataPoint(C,p)])}V.style("display",A?null:"none"),x=V.selectAll("tr.nonHeader").data(m),x.exit().remove(),l(x),P=x.enter().append("tr").attr("class","nonHeader"),l(P);var w=n(a,"specTable",[$.t("search.recordSpec")],"Specimens Table"),k=d.getSpecimens(v);if(m=[],k)for(var y=0;y<k.length;y++)m.push([d.getIndexedDataPoint(k[y],p)]);w.style("display",k?null:"none"),x=w.selectAll("tr.nonHeader").data(m),x.exit().remove(),l(x),P=x.enter().append("tr").attr("class","nonHeader"),l(P)}a.selectAll("table").style("visibility",void 0===u?"collapse":"visible")},this.updateVals=this.update,this.destroy=function(){VESPER.DWCAHelper.recurseClearEvents(d3.select(e)),u=void 0,d.removeView(v),d=null,VESPER.DWCAHelper.twiceUpRemove(e)}},VESPER.Sanity=function(e){function t(){r=p(),i=h(),o=f(),s=!1}var n,a,r,i,o,l=this,s=!0,c=100,d=d3.format(",");this.set=function(e,t){n=t,VESPER.log("sanity model",n)},this.go=function(){a=this,this.update()};var u=function(e){var t=e.value||e;return t.mappedRowType+":"+t.fileName},p=function(e){var t=[],a=[],r=n.getData(),i=n.getParser().neccLists;for(var o in i)if(i.hasOwnProperty(o)){var l=n.makeIndices(i[o]),s=MGNapier.NapVisLib.countNulls(l);0===s&&(t.push(l),a.push({listName:$.t("sanity.visLabels."+o),all:0,some:0}))}var c=0;for(var d in r)if(r.hasOwnProperty(d)&&(!e||e(n,d))){c++;for(var u=0;u<t.length;u++){for(var p=t[u],h=!1,f=!0,v=0;v<p.length;v++){var g=n.getIndexedDataPoint(r[d],p[v]);void 0==g?h=!0:f=!1}h&&a[u].some++,f&&a[u].all++}}return{outputs:a,dataCount:c}},h=function(e){for(var t=d3.entries(n.getMetaData().fileData),a=n.getData(),r={},i=0;i<t.length;i++){var o=t[i].value.filteredInvFieldIndex,l=u(t[i]);r[l]={};for(var s=0;s<o.length;s++)r[l][o[s]]={recordType:l,name:o[s],count:0}}var c=t.filter(function(e){return e.value.filteredInvFieldIndex.length>0});for(var d in a)if(a.hasOwnProperty(d)&&(!e||e(n,d)))for(var i=0;i<c.length;i++){var p=c[i].value,o=p.filteredInvFieldIndex,h=n.getRowData(a[d],p.extIndex);h&&void 0!=p.extIndex&&(h=h[0]);for(var l=u(p),s=0;s<o.length;s++){var f=o[s];(void 0==h||void 0==h[s])&&r[l][f].count++}}var v={};for(var g in r)if(r.hasOwnProperty(g)){var m=r[g];for(var E in m)m.hasOwnProperty(E)&&(v[g+" "+E]=m[E])}return v},f=function(){for(var e=d3.entries(n.getMetaData().fileData),t={},a=0;a<e.length;a++){var r=e[a].value.fieldData;for(var i in r)if(r.hasOwnProperty(i)){var o=d3.values(r[i].discreteTermList);o.length>0&&(t[i]={name:i,count:o.length})}}return t},v=function(e,t){return e.getSelectionModel().contains(t)},g=function(e){return isNaN(e)?e:d(e)};this.update=function(){function a(e,t,n,a){var r=S.select("table."+e);if(r.empty()){var i=S.append("table").attr("class",e).attr("data-tooltipHeader",a);i.append("caption").attr("class","sanityCaption").text(n),i.append("tr").selectAll("th").data(t).enter().append("th").attr("class","sanityTableHeading").text(function(e){return e})}return S.select("table."+e)}function l(e){var t=S.select("table."+e);t.remove()}function d(e,t){e.exit().remove(),e.enter().append("tr").attr("class","sanityRow"),e.each(t)}function u(e){function t(e,t){var n=F[t].func?F[t].func(e.value):e.value;return g(e.value)+(isNaN(e.value)||n===e.value?"":" ("+L(n)+")")}for(var a=[],r=[],i=0;i<F.length;i++){var o=F[i].name;void 0!==e[o]&&(a.push({key:o,value:e[o]}),r.push(o))}e.ordering=r,d3.select(this).on("mouseout",function(){VESPER.tooltip.setToFade()}).on("mouseover",function(e){var t=d3.select(this.parentNode).selectAll("th"),a=[];t.each(function(e){a.push(e)});for(var i="",o=0;o<r.length;o++)i+=a[o]+": "+g(e[r[o]])+(o<r.length-1?"<br>":"");var l;e.name&&(l=n.getParser().descriptors[e.name])&&(i+="<br><br>"+$.t("sanity.fieldDescLabel")+": "+l);var s=d3.select(this.parentNode).attr("data-tooltipHeader");s||(s=$.t("sanity.defaultTooltipHeader")),VESPER.tooltip.updateText(s,i).updatePosition(d3.event)});var l=d3.select(this).selectAll("td").data(a);l.enter().append("td").attr("class",function(e,t){return F[t]&&F[t].klass?F[t].klass:null}),l.select("div").empty()&&l.append("div").attr("class",function(e,t){return F[t].func===E?"selected":"unselected"}).style("height","10px"),l.select("div").style("width",function(e,t){var n=F[t].func?F[t].func(e.value):e.value;return isNaN(e.value)?0:Math.min(c,n*c)+"px"}).style("display",function(e){return isNaN(e.value)||0==e.value?"none":null}),l.select("span.sanityBarText").empty()&&l.append("span").attr("class","sanityBarText"),l.select("span.sanityBarText").text(t)}function f(e){return e}function m(e){return e/D}function E(e){return y>0?e/y:0}var S=d3.select(e);s&&t();for(var y=n.getSelectionModel().values().length,x=p(v),P=h(v),R=r.outputs,D=r.dataCount,T=0;T<R.length;T++){var b=R[T],V=x.outputs[T];b.selSome=V.some,b.selAll=V.all}for(var A in i)if(i.hasOwnProperty(A)){var C=i[A],w=P[A];C.selCount=w.count}var k=S.select("div.sanityHeader");k.empty&&S.append("div").attr("class","sanityHeader").append("p"),S.select("div.sanityHeader").select("p").text(g(D)+" Records"+(y>0?", "+g(y)+" Selected":""));for(var L=d3.format(".2%"),I=[],T=0;5>T;T++)I.push($.t("sanity.visSanHeaders."+T));var N=a("visSanityTests",I,$.t("sanity.visSanHeaders.tableCaption"),$.t("sanity.visSanHeaders.tooltipHeader")),F=[{name:"listName",func:f,klass:"showSanityText"},{name:"some",func:m,klass:"dontShowSanityText"},{name:"all",func:m,klass:"dontShowSanityText"},{name:"selSome",func:E,klass:"dontShowSanityText"},{name:"selAll",func:E,klass:"dontShowSanityText"}];d(N.selectAll("tr.sanityRow").data(R),u);for(var M=[],T=0;4>T;T++)M.push($.t("sanity.fieldSanHeaders."+T));$.isEmptyObject(i)||(N=a("fieldSanityTests",M,$.t("sanity.fieldSanHeaders.tableCaption"),$.t("sanity.fieldSanHeaders.tooltipHeader")),F=[{name:"recordType",func:f,klass:"showSanityText"},{name:"name",func:f,klass:"showSanityText"},{name:"count",func:m,klass:"dontShowSanityText"},{name:"selCount",func:E,klass:"dontShowSanityText"}],d(N.selectAll("tr.sanityRow").data(d3.values(i)),u));for(var O=[],T=0;2>T;T++)O.push($.t("sanity.vocabSanHeaders."+T));$.isEmptyObject(o)?l("vocabSanityTests"):(N=a("vocabSanityTests",O,$.t("sanity.vocabSanHeaders.tableCaption"),$.t("sanity.vocabSanHeaders.tooltipHeader")),F=[{name:"name",func:f,klass:"showSanityText"},{name:"count",func:f,klass:"showSanityText"}],d(N.selectAll("tr.sanityRow").data(d3.values(o)),u))},this.updateVals=this.update,this.destroy=function(){VESPER.DWCAHelper.recurseClearEvents(d3.select(e)),n.removeView(l),n=null,VESPER.DWCAHelper.twiceUpRemove(e)}},VESPER.Tree=function(e){function t(e){return void 0!==e&&"*"===e.charAt(0)?"url(#"+M+")":null}function n(e){if(!L)return null;var t=o(e),n=y.getIndexedDataPoint(t,b);return k(n)}function a(e){return t(e)||n(e)}function r(e){var t=y.getObjectCount(e),n=y.getSelectedObjectCount(e),a=n>0&&t>0?Math.log(n+1)/Math.log(t+1):0;return a}function i(){var t=d3.select(e).append("div").attr("class","visControl").attr("id",x+"controls"),n=function(e){return x+e.key};VESPER.DWCAHelper.addDragArea(t);var a=t.append("div").attr("id",x+"accordion"),r=[$.t("tree.sizeLabel"),$.t("tree.layoutLabel"),$.t("tree.sortLabel")];a.selectAll("h3").data(r).enter().append("h3").text(function(e){return e}),a.selectAll("div.accordSection").data(["Space","Layout","Sort"]).enter().insert("div",function(e,t){return a.select("h3:nth-of-type("+(t+2)+")").node()}).attr("class","accordSection").attr("id",function(e){return x+"controls"+e});var i=d3.select(e+"controlsSpace");VESPER.DWCAHelper.addRadioButtons(i,d3.entries(B),"fieldGroup",x+"alloc",n,function(e){return U[e.key]}),i.selectAll("input").property("checked",function(e){return g===e.value}).on("change",function(e){return g=e.value,l(v),!1}),i=d3.select(e+"controlsLayout"),VESPER.DWCAHelper.addRadioButtons(i,d3.entries(_),"fieldGroup",x+"layout",n,function(e){return j[e.key]}),i.selectAll("input").property("checked",function(e){return m===e.value}).on("change",function(e){m=e.value;var t=p.selectAll(".treeNode");return c(t),t.remove(),l(v),!1}),i=d3.select(e+"controlsSort"),VESPER.DWCAHelper.addRadioButtons(i,d3.entries(O),"fieldGroup",x+"sort",n,function(e){return W[e.key]}),i.selectAll("input").property("checked",function(e){return E===e.value}).on("change",function(e){return E=e.value,l(v),!1}),$(e+"accordion").accordion({heightStyle:"content",collapsible:!0,active:!1}),$(e+"controls").draggable({handle:"div.dragHandle",containment:e})}function o(e){var t=y.getNodeFromID(e);return void 0==t&&e&&(t=y.getNodeFromID(e.substring(1))),t}function l(e){w&&(VESPER.alerts&&alert("about to calc layout"),w=!1),g.size(m.sizeBounds()).cutoff(m.cutoffVal).sort(E),VESPER.log("what alloc reports ",g.size()),VESPER.log("root",e);var t=g.nodes(e);VESPER.log(t.length,t),v=e;var n=p.selectAll(".treeNode").data(t,function(e){return e.id});m.prep(t),m.removeOld(n.exit());var a=n.exit().empty()?0:V;m.redrawExistingNodes(n,a),a+=n.empty()?0:A;var r=m.makeNew(n.enter());MGNapier.NapVisLib.d3fadeInNewGroups([r],C,a)}function s(e){var t=y.getIndexedDataPoint(e,T);if(!y.getSelectedDescendantCount(e)||y.getSelectionModel().contains(t))return e;var n=y.getSubTaxa(e);if(n){for(var a,r=0,i=0;i<n.length;i++){var o=n[i],l=y.getIndexedDataPoint(o,T);y.getSelectionModel().contains(l)?r++:y.getSelectedDescendantCount(o)>0&&(r++,a=o)}if(r>1)return e;a&&(e=s(a))}return e}function c(e){e.on("click",null).on("mouseover",null).on("mouseout",null).on("contextmenu",null)}function d(e){e.on("click",function(e){var t=o(e.id);l(t===v&&void 0!=t.parent?t.parent:t)}).on("mouseover",function(e){d3.select(this).selectAll("*").classed("highlight",!0);var t=o(e.id),n=R.tooltipString(t,y,P);VESPER.tooltip.updateText(y.getLabel(t),n).updatePosition(d3.event)}).on("mouseout",function(){VESPER.tooltip.setToFade(),d3.select(this).selectAll("*").classed("highlight",!1)}).on("contextmenu",function(e){y.selectSubTree(o(e.id),T),d3.event.preventDefault()})}var u,p,h,f,v,g,m,E,S,y,x,P,R=this,D=d3.behavior.zoom();D.scaleExtent([1,4]);var T,b,V=400,A=1e3,C=400,w=!0,k=d3.scale.category20c(),L=!1,I={},N={},F="hatch",M="hatch",O={Alpha:function(e,t){var n=y.getLabel(e),a=y.getLabel(t);return a>n?-1:n>a?1:0},Descendants:function(e,t){var n=R.containsCount(e,y)||0,a=R.containsCount(t,y)||0;return n>a?-1:a>n?1:0},Selected:function(e,t){var n=y.getSelectionModel(),a=n.contains(y.getIndexedDataPoint(e,T)),r=n.contains(y.getIndexedDataPoint(t,T));return a===r?0:a===!0?-1:1},SelectedDesc:function(e,t){var n=y.getSelectedObjectCount(e),a=y.getSelectedObjectCount(t);return n===a?0:void 0===n?1:void 0===a?-1:a-n}},W={Alpha:$.t("tree.sortAlpha"),Descendants:$.t("tree.sortDesc"),Selected:$.t("tree.sortSel"),SelectedDesc:$.t("tree.sortDescSel")};this.ttipNumFormat=d3.format(","),this.tooltipString=function(){return"Placeholder"};var B={bottomUp:MGNapier.AdaptedD3.bottomUp().sort(null).value(function(e){return y.getLeafValue(e)}).children(function(e){return y.getSubTaxa(e)}).nodeId(function(e){return y.getIndexedDataPoint(e,T)}),bottomUpLog:MGNapier.AdaptedD3.logPartition().sort(null).value(function(e){return y.getLeafValue(e)}).children(function(e){return y.getSubTaxa(e)}).nodeId(function(e){return y.getIndexedDataPoint(e,T)}),topDown:MGNapier.AdaptedD3.topDown().sort(null).value(null).children(function(e){return y.getSubTaxa(e)}).nodeId(function(e){return y.getIndexedDataPoint(e,T)})},U={bottomUp:$.t("tree.sizeBottomUp"),bottomUpLog:$.t("tree.sizeBottomUpLog"),topDown:$.t("tree.sizeTopDown")};this.colourByRanks=function(e){k.domain(e),L=!L,m.updateFills(p.selectAll(".treeNode"))},this.containsCount=function(e){return y.getDescendantCount(e)||0};var H=20,G={cutoffVal:4,sizeBounds:function(){return[h[1]-H,h[0]-H]},booleanSelectedAttrs:function(e){e.attr("class",function(e){return y.getSelectionModel().contains(e.id)?"selected":"unselected"}).attr("y",function(e){return e.x}).attr("x",function(e){return e.y}).attr("width",function(e){return e.dy}).attr("height",function(e){return e.dx})},widthLogFunc:function(e){var t=o(e.id);return r(t)*e.dy},xFunc:function(e){var t=o(e.id),n=r(t);return e.y+(1-n)*e.dy},propSharedAttrs:function(e,t,n){e.attr("class","holdsSelected").attr("y",function(e){return e.x}).attr("x",t).attr("height",function(e){return e.dx}).attr("width",n)},sharedTextAttrs:function(t){function n(e,t){return e.dx>e.dy&&t.getComputedTextLength()<e.dx-4}t.attr("transform",function(e){var t=n(e,this);if(t){var a=this.getComputedTextLength(),r=Math.max(0,(e.dx-a)/2);return"translate ("+e.y+","+e.x+")  rotate (90 0 0) translate ("+r+", -"+e.dy/2+")"}return"translate ("+e.y+","+(e.x+Math.max((e.dx-14)/2+14,14))+") "}).attr("clip-path",function(t){return n(t,this)?null:"url("+e+"depthclipR0)"})},prep:function(e){p.attr("transform","translate("+H/2+","+H/2+")"),G.makeTextClips(e)},removeOld:function(e){c(e),MGNapier.NapVisLib.d3fadeAndRemoveGroups([e],V,0)},makeNew:function(e){var t=e.append("svg:g").attr("class","treeNode").style("opacity",0).call(d);return t.append("svg:rect").call(G.booleanSelectedAttrs).style("fill",function(e){return a(e.id)}),t.append("svg:rect").style("opacity",.75).call(G.propSharedAttrs,this.xFunc,this.widthLogFunc),t.append("svg:text").text(function(e){return y.getLabel(o(e.id))}).style("display",function(e){return e.dx>15&&e.dy>15?null:"none"}).call(G.sharedTextAttrs),t},redrawExistingNodes:function(e,t){e.select("rect:not(.holdsSelected)").transition().delay(t).duration(A).call(G.booleanSelectedAttrs),e.select("rect.holdsSelected").transition().delay(t).duration(A).call(G.propSharedAttrs,this.xFunc,this.widthLogFunc),e.select("text").style("display",function(e){return e.dx>15&&e.dy>15?null:"none"}).transition().delay(t).duration(A).call(G.sharedTextAttrs)},updateFills:function(e){e.select("rect:not(.holdsSelected)").style("fill",function(e){return a(e.id)})},makeTextClips:function(e){for(var t=u.node().getBoundingClientRect().height,n=[],a=0;a<e.length;a++){var r=e[a],i=o(r.id);n[i.depth]||(n[i.depth]={depth:i.depth,x:r.y,y:-20,width:r.dy,height:t+20})}var l=u.select("defs").selectAll(".napierClipR").data(n),s=function(e){e.attr("x",function(e){return e.x}).attr("y",function(e){return e.y}).attr("width",function(e){return e.width}).attr("height",function(e){return e.height})};l.exit().remove(),l.select("rect").call(s),l.enter().append("clipPath").attr("class","napierClipR").attr("id",function(e){return x+"depthclipR"+e.depth}).append("rect").call(s)}},z={cutoffVal:.05,sizeBounds:function(){var e=d3.min(h)/2;return VESPER.log("DIMS",h,e),[2*Math.PI,e*e]},booleanSelectedAttrs:function(e){e.attr("class",function(e){return y.getSelectionModel().contains(e.id)?"selected":"unselected"})},propSelectedAttrs:function(e){e.attr("class","holdsSelected")},sharedTextAttrs:function(t){t.attr("transform",function(e){var t=o(e.id);if(0===t.depth)return"translate (0,0)";var n=(e.x+e.dx/2)*(360/(2*Math.PI))-90;return"rotate ("+n+" 0 0) translate ("+Math.sqrt(e.y)+",0) "}).style("text-anchor",function(e){return 0===o(e.id).depth?"middle":null}).style("display",function(e){return e.dx>.1&&Math.sqrt(e.y+e.dy)-Math.sqrt(e.y)>20?null:"none"}).attr("clip-path",function(t){return"url("+e+"depthclip"+o(t.id).depth+")"})},arc:d3.svg.arc().startAngle(function(e){return e.x}).endAngle(function(e){return e.x+e.dx}).innerRadius(function(e){return Math.sqrt(e.y)}).outerRadius(function(e){return Math.sqrt(e.y+e.dy)}),parc:d3.svg.arc().startAngle(function(e){return e.x}).endAngle(function(e){return e.x+e.dx}).innerRadius(function(e){var t=o(e.id),n=r(t),a=Math.sqrt(e.y+e.dy-n*e.dy);return a}).outerRadius(function(e){return Math.sqrt(e.y+e.dy)}),cstash:function(e){I[e.id]={x0:e.x,dx0:e.dx,y0:e.y,dy0:e.dy}},pstash:function(e){N[e.id]={x0:e.x,dx0:e.dx,y0:e.y,dy0:e.dy}},arcTween:function(e){var t=I[e.id];if(void 0===t&&VESPER.log("No STORE",e.id,e),t){var n=d3.interpolate({x:t.x0,dx:t.dx0,y:t.y0,dy:t.dy0},e);return function(e){var a=n(e);return t.x0=a.x,t.dx0=a.dx,t.y0=a.y,t.dy0=a.dy,z.arc(a)}}},parcTween:function(e){var t=N[e.id],n=d3.interpolate({x:t.x0,dx:t.dx0,y:t.y0,dy:t.dy0},e);return function(e){var a=n(e);return t.x0=a.x,t.dx0=a.dx,t.y0=a.y,t.dy0=a.dy,z.parc(a)}},prep:function(e){p.attr("transform","translate("+h[0]/2+","+h[1]/2+")"),z.makeTextClips(e)},removeOld:function(e){c(e),e.transition().delay(0).duration(0).each("end",function(){var e=d3.select(this).datum().id;I[e]=void 0,N[e]=void 0}),MGNapier.NapVisLib.d3fadeAndRemoveGroups([e],V,0)},makeNew:function(e){var t=e.append("svg:g").attr("class","treeNode").style("opacity",0).call(d);return t.append("path").attr("d",z.arc).call(z.booleanSelectedAttrs).style("fill",function(e){return a(e.id)}).each(z.cstash),t.append("path").attr("d",z.parc).style("opacity",.75).call(z.propSelectedAttrs).each(z.pstash),t.append("svg:text").text(function(e){return y.getLabel(o(e.id))}).call(z.sharedTextAttrs),t},redrawExistingNodes:function(e,t){e.select("path:not(.holdsSelected)").call(z.booleanSelectedAttrs).transition().delay(t).duration(A).attrTween("d",z.arcTween).each("end",z.cstash),e.select("path.holdsSelected").call(z.propSelectedAttrs).transition().delay(t).duration(A).attrTween("d",z.parcTween).each("end",z.pstash);var n=function(){d3.select(this).call(z.sharedTextAttrs)};e.select("text").style("display","none").transition().delay(t).duration(A).each("end",n)},updateFills:function(e){e.select("path:not(.holdsSelected)").style("fill",function(e){return a(e.id)})},makeTextClips:function(e){for(var t=[],n=0;n<e.length;n++){var a=e[n],r=o(a.id);t[r.depth]||(t[r.depth]={depth:r.depth,inner:Math.sqrt(a.y),outer:Math.sqrt(a.y+a.dy)})}var i=u.select("defs").selectAll(".napierClip").data(t),l=function(e){e.attr("cx",0).attr("cy",0).attr("r",function(e){return e.outer-e.inner})};i.exit().remove(),i.select("circle").call(l),i.enter().append("clipPath").attr("class","napierClip").attr("id",function(e){return x+"depthclip"+e.depth}).append("circle").call(l)}},_={Icicle:G,Sunburst:z},j={Icicle:$.t("tree.layoutIcicle"),Sunburst:$.t("tree.layoutSunburst")};this.set=function(t,n){P=n.makeIndices([t.identifyingField,t.rankField]),VESPER.log("FIELDS",t,n,P),T=P[0],b=P[1],h=[$(e).width(),$(e).height()],y=n},this.go=function(){S=this,d3.select(e).style("overflow","hidden"),x=e.substring(1),M=F+x,u=d3.select(e).append("svg:svg").attr("class","visContainer").attr("pointer-events","all"),u.append("defs");var t=u.select("defs").append("pattern").attr("id",M);t.attr("x",0).attr("y",0).attr("width",4).attr("height",4).attr("patternUnits","userSpaceOnUse").attr("viewBox","0 0 4 4 ");var n=[0,2];t.selectAll("rect").data(n).enter().append("rect").attr("x",function(e,t){return 2*t}).attr("y",function(e,t){return 2*t}).attr("width",2).attr("height",2).attr("class","indHatch").classed("unselected",!0),p=u.append("svg:g").attr("class","treeSVG");var a=y.getSelectionModel().values(),r=1===a.length?o(a[0]):R.getRoot(y);return void 0===r?void VESPER.log("no root defined for tree",R.getRoot(y),r,a):(f=r,g=B.bottomUpLog,E=O.Alpha,m=_.Sunburst,i(),this.doExtra(),void this.update())},this.resized=function(){d3.select(e).style("height","95%"),h=[$(e).width(),$(e).height()],l(v)},this.doExtra=function(){},this.update=function(){var e=y.getSelectionModel().values(),t=1===e.length?o(e[0]):R.getRoot(y);VESPER.log("Root",t,e[0]),y.countSelectedDesc(R.getRoot(y),T),t=s(R.getRoot(y)),l(t)},this.getRoot=function(e){return e.getImplicitRoot()},this.updateVals=this.update,this.redraw=function(){var e=p.selectAll(".treeNode");m.redrawExistingNodes(e,0)},this.getModel=function(){return y},this.destroy=function(){c(p.selectAll(".treeNode")),p.selectAll(".treeNode").remove(),$(e+"controls").draggable("destroy"),$(e+"accordion").accordion("destroy"),y.removeView(R),y=null,f=null,v=null,I={},N={},VESPER.DWCAHelper.twiceUpRemove(e)}},VESPER.ImplicitTaxonomy=function(e){var t=new VESPER.Tree(e);return t.type="impTree",t.getRoot=function(e){return e.getImplicitRoot()},t.tooltipString=function(e,t,n){console.log("tooltip node",e);for(var a=t.getDescendantCount(e),r=t.getSelectedDescendantCount(e),i=t.getSubTaxa(e),o="",l=0;l<n.length;l++)n[l]&&(o+=(l>0?"<br>":"")+n[l].fieldType+": "+t.getIndexedDataPoint(e,n[l]));o+=(void 0===i?"":"<hr>"+$.t("tree.taxaTooltip",{count:a}))+(r>0?void 0===i?"":"<br>"+$.t("tree.taxaSelTooltip",{count:r}):"");var s=t.getSynonymCount(e);if(s){o+="<hr>"+$.t("tree.synTooltip",{count:s});var c=t.getSelectedSynonymCount(e);c&&(o+="<br>"+$.t("tree.synSelTooltip",{syn:c}))}var d=t.getSynonyms(e);if(d)for(o+="<hr><i>"+$.t("tree.synLabel")+"</i>",l=0;l<d.length;l++){var u=t.getIndexedDataPoint(d[l],n[0]),p=t.getSelectionModel().contains(u)?"selected":"";o+='<br><span class="'+p+'">'+u+"</span>: "+t.getLabel(d[l])}return o},t.doExtra=function(){var n=d3.select(e+"controls"),a=n.select("div"+e+"accordion");a.append("h3").text($.t("tree.rankLabel"));var r=a.append("div").attr("class","accordSection").attr("id",e.substring(1)+"controlsRanks");r.append("button").text($.t("tree.flagKnownRankLabel")).on("click",function(){t.getModel().getSelectionModel().clear(),VESPER.Filters.standardRankFilter(t.getModel())});var i=VESPER.DWCAHelper.addCheckboxes(r,[{title:$.t("tree.colourRanksLabel")}],null);i.on("click",function(){var e=t.getModel().makeIndex("taxonRank"),n=t.getModel().getMetaData(),a=n.fileData[e.rowType],r=a.fieldData[e.fieldType],i=r.discreteTermList;t.colourByRanks(d3.keys(i))}),$(e+"accordion").accordion("destroy"),$(e+"accordion").accordion({heightStyle:"content",collapsible:!0,active:!1})},t},VESPER.ExplicitTaxonomy=function(e){var t=new VESPER.Tree(e);return t.type="expTree",t.getRoot=function(e){return e.getExplicitRoot()},t.containsCount=function(e,t){return t.getSpecimenCount(e)||0},t.tooltipString=function(e,t,n){console.log("tooltip node",e);for(var a=t.getSpecimens(e),r="",i=10,o=0;o<n.length;o++)n[o]&&(r+=(o>0?"<br>":"")+n[o].fieldType+": "+t.getIndexedDataPoint(e,n[o]));var l=t.getSpecimenCount(e);if(l){r+="<hr>"+$.t("tree.specTooltip",{count:l});var s=t.getSelectedSpecimenCount(e);s&&(r+="<br>"+$.t("tree.specSelTooltip",{count:s}))}if(a){for(r+="<hr><i>"+$.t("tree.specLabel")+"</i>",o=0;o<Math.min(a.length,i);o++){var c=a[o],d=t.getIndexedDataPoint(c,n[0]),u=t.getSelectionModel().contains(d)?"selected":"";r+='<br><span class="'+u+'">'+d+"</span>, "+t.getLabel(c)}a.length-i>0&&(r+="<br>"+$.t("tree.andMore",{count:a.length-i}))}return r},t};var VESPER=VESPER||{};VESPER.tooltip=new function(){this.holdDuration=1e4,this.fadeDuration=200;var e=10,t=this;return this.init=function(){var e=d3.select("body").selectAll("#vesperTooltip").data([0]).enter().append("div").attr("id","vesperTooltip").attr("class","vesperTooltip").style("visibility","hidden");return e.append("h2"),e.append("p"),this},this.setToFade=function(){var e=d3.select("#vesperTooltip");return e.transition().duration(t.fadeDuration).style("opacity",0).each("end",function(){d3.select(this).style("visibility","hidden")}),this},this.updateText=function(e,n){var a=d3.select("#vesperTooltip");return a.select("h2").text(e),a.select("p").html(n),a.transition().style("visibility","visible").style("opacity",null).transition().duration(t.holdDuration).each("end",function(){t.setToFade()}),this},this.updatePosition=function(t){if(t){var n,a,r=d3.select("#vesperTooltip"),i=$(document).width(),o=$(document).height(),l=$(window).width(),s=$(window).height(),c=$(document).scrollLeft(),d=$(document).scrollTop(),u=t.pageX,p=t.pageY,h=$("#vesperTooltip").outerWidth(),f=$("#vesperTooltip").outerHeight(),v=i&&o&&h&&f&&l&&s;if(v){var g=p+f+e<Math.min(o,s+d);a=g?p+e:p-f-e;var m=u+h+e<Math.min(i,l+c);n=m?u+e:u-h-e}else n=u,a=p;r.style("top",a+"px").style("left",n+"px")}return this},this},VESPER.VisLauncher=function(e,t){function n(e){var t=d.makeIndices(e.attList),n=MGNapier.NapVisLib.countNulls(t);return 0===t.length||e.matchAll&&0===n||!e.matchAll&&n<t.length}function a(e){var t=d.makeIndices(e.attList);return t.length>0}function r(t){d3.select(e).append("H3").text($.t("launcher.launchHeader"));var n=d3.select(e).append("div").attr("id",e+"Vis").selectAll("button").data(t),a=n.enter().append("button").attr("class","visChoice").attr("type","button").on("click",function(e){var t=f.makeVis(e,d);return t&&t.style("z-index",100),!1}).on("mouseover",function(e){VESPER.tooltip.updateText(VESPER.titles[e.type],$.t("vesper.visHelpTips."+e.type)).updatePosition(d3.event)}).on("mouseout",function(){VESPER.tooltip.setToFade()});a.append("img").attr("src",function(e){return e.icon||e.image}).attr("class","vesperIcon"),a.append("span").text(function(e){return VESPER.titles[e.type]})}function i(){d3.select(e).append("H3").text($.t("launcher.selectHeader"));var t=d3.select(e).append("div").attr("id",e+"Sel");t.append("button").attr("type","button").attr("value","launcher.selectSave").text($.t("launcher.selectSave")),window.requestFileSystem?t.select("button").on("click",function(){MGNapier.NapVisLib.prepareForWrite(MGNapier.NapVisLib.writeArray,d.getSelectionModel().values())}):MGNapier.NapVisLib.html5LacksOnButton(t.select("button"),$.t("launcher.noFileWriter")),t.append("button").attr("type","button").attr("value","launcher.selectInvert").text($.t("launcher.selectInvert")).on("click",function(){d.invertSelection()}),t.append("button").attr("type","button").attr("value","launcher.selectClear").text($.t("launcher.selectClear")).on("click",function(){d.getSelectionModel().clear(),d.getSelectionModel().update()}),t.selectAll("button").style("display","block").attr("class","safetyGap").on("mouseover",function(){var e=d3.select(this),t=e.attr("value"),n=e.text();VESPER.tooltip.updateText(n,$.t("launcher.helpTips"+t.substring(t.indexOf(".")))).updatePosition(d3.event)}).on("mouseout",function(){VESPER.tooltip.setToFade()})}function o(){d3.select(e).append("H3").text($.t("launcher.compareHeader"));var t=d3.select(e).append("div").attr("id",e+"TComp"),n=$.t("launcher.compareLabel");t.append("button").attr("type","button").attr("class","compareVesperModel").text(n).on("click",function(){if(VESPER.modelBag.push({model:d}),VESPER.log("ModelBag",VESPER.modelBag),VESPER.modelBag.length>1)VESPER.modelComparisons.modelCoverageToSelection(VESPER.modelBag[0].model,VESPER.modelBag[1].model,VESPER.modelBag[0].model.getMetaData().vesperAdds.nameLabelField,VESPER.modelBag[1].model.getMetaData().vesperAdds.nameLabelField),VESPER.modelBag.length=0,d3.selectAll("button.compareVesperModel").classed("taxonomyCompareActive",!1).text(n);else{var e=d3.select(this);e.classed("taxonomyCompareActive",!0),d3.selectAll("button.compareVesperModel").filter("*:not(.taxonomyCompareActive)").text(n+" to "+d.name)}}).on("mouseover",function(){VESPER.tooltip.updateText(n,$.t("launcher.helpTips.compareLabel")).updatePosition(d3.event)}).on("mouseout",function(){VESPER.tooltip.setToFade()}),t.selectAll("button").style("display","block")}function l(e){var t=e.selectAll("button.visChoice");t.style("display",function(e){var t=n(e);return t?"block":"none"})}function s(e,t){e.append("button").attr("type","button").on("click",function(){t&&t.destroy&&t.destroy(),d3.select(d3.event.target).on("click",null)}).attr("title",$.t("launcher.closeTooltip")).append("span").text("X").attr("alt","Close")}function c(e,t,n){e.append("button").attr("type","button").on("click",function(){var e=d3.select(t),a=d3.select(n),r=e.style("display"),i="none"===r;i||(v[t]=a.style("height")),a.style("min-height",i?"200px":null).style("height",i?v[t]:a.select(".dragbar").style("height")),e.style("display",i?null:"none"),d3.select(this).select("span").text(i?"▲":"▼")}).attr("title",$.t("launcher.hideTooltip")).append("span").text("▲").attr("class","showHideColours")}var d,u,p,h,f=this,v={};this.set=function(t,n){u=t.identifyingField,h=t.visChoiceData,p=[$(e).width(),$(e).height()],d=n},this.go=function(){var s=d3.select(e);if(r(h),l(s),i(),o(),$(function(){$(e).accordion({heightStyle:"content",collapsible:!0,active:!1})}),t&&"on"===t.autoLaunch)for(var c=0;c<h.length;c++){var u=h[c];n(u)&&a(u)&&f.makeVis(u,d)}},this.update=function(){},this.updateVals=this.update,this.makeVis=function(e,t){var n=t.getNextSessionModelViewID(),a=t.name+"view"+(e.multiple?n:"");a="D"+a.replace(/\s+[a-z]/g,function(e){return e.toUpperCase()}).replace(/\s+/g,"");var r=VESPER.titles[e.type],i=r+" "+t.name,o=n%10*10+"%";if(d3.select("#"+a).empty()){var l=a+"container",d=d3.select("#allVisDiv").append("div").attr("class","visWrapper").attr("id",l).style("width",e.width?e.width:"40%").style("left",o).style("top",o),u=d.append("div").attr("class","dragbar").attr("id",a+"dragBar"),p=u.append("div").attr("class","buttonBank");u.append("div").attr("class","visTitle").text(i),d.append("div").attr("class","vis").attr("id",a).style("height","null"!=e.height?e.height:"auto"),d.style("min-height","200px").style("min-width","200px");
var h=t.getMetaData().fileData,f=e.newVisFunc("#"+a);VESPER.log("newvis",f,f.set);var v=e.setupFunc()||{},g=h.core.filteredInvFieldIndex[t.getParser().getFilteredIdIndex(t.getMetaData())];return v.identifyingField=g,f.set(v,t),t.addView(f),f.go(t),c(p,"#"+a,"#"+l),s(p,f),$("#"+l).draggable({handle:"div.dragbar",containment:"#allVisDiv",stack:".visWrapper",stop:function(){}}).resizable({stop:function(){f.resized&&f.resized()}}),d.style("position","absolute"),d}return null},this.destroy=function(){for(var t=d.getSelectionModel().getVis(),n=0;n<t.length;n++)t[n]!==f&&(t[n].destroy&&t[n].destroy(),d.removeView(t[n]));var a=$.inArray(d,VESPER.modelBag);a>=0&&(VESPER.modelBag[a]=void 0,VESPER.modelBag=VESPER.modelBag.splice(a,1),VESPER.modelBag.length=0),VESPER.DWCAHelper.recurseClearEvents(d3.select(e)),d.removeView(f),d.getSelectionModel().clear(),d=null,VESPER.DWCAHelper.twiceUpRemove(e)}};